import{j as e,r as n,u as Wt,g as Gt,I as it,a as ct,b as Ut,c as qt,d as Rt,e as Xt,f as Ht,h as Kt,s as Yt,q as Jt,i as Qt,k as Zt,l as es,m as ts,n as ss}from"./index-BHgq2Ao1.js";import{B as Te}from"./BottomSheet-GpOlSyzm.js";import{p as gt,f as Je,a as Lt,b as ns,c as rs,u as as}from"./usePromptAliases-DLcvEuec.js";function os(t,s){if(!s||s<=0)return null;const a=Number(t)||0,r=Number(s)||0,o=Math.round(a/r*100);return Number.isFinite(o)?Math.max(0,Math.min(100,o)):null}function ls({busy:t=!1,progressValue:s=0,progressMax:a=0,statusText:r="Idle",statusPhase:o="idle",primaryLabel:l="Render",onPrimary:c,primaryDisabled:d=!1}){const y=os(s,a),g=o==="queued"?"rgba(255, 143, 112, 0.95)":o==="running"?"rgba(68, 225, 197, 0.95)":o==="finished"?"rgba(92, 255, 154, 0.95)":o==="error"?"rgba(255, 143, 112, 0.95)":"rgba(159, 178, 215, 0.55)",N={idle:"Idle",queued:"Queued",running:"Running",finished:"Finished",error:"Error"}[o]||"Status",R=t||d;return e.jsxs("div",{className:"dock-bar-inner",children:[e.jsx("button",{type:"button",onClick:c,disabled:R,className:"dock-primary-btn",children:t?"Rendering…":l}),e.jsxs("div",{className:"dock-status-row",children:[e.jsxs("span",{className:"dock-status-left",children:[e.jsx("span",{className:"dock-status-dot",style:{background:g}}),e.jsx("span",{className:"dock-status-label",children:N})]}),e.jsxs("span",{className:"dock-status-right",children:[y!=null&&t?e.jsxs("span",{className:"dock-progress",children:[e.jsx("span",{className:"dock-progress-bar","aria-hidden":"true",children:e.jsx("span",{className:"dock-progress-fill",style:{width:`${y}%`}})}),e.jsxs("span",{children:[y,"%"]})]}):null,e.jsx("span",{className:"dock-status-text",children:r||(t?"Working…":"Idle")})]})]})]})}const Mt="jpg,jpeg,png,webp,gif,bmp,tif,tiff",xt=(t="")=>/\.(png|jpe?g|gif|webp|bmp|tif?f)$/i.test(t),Dt=(t="")=>/\.(mp4|webm|mov|mkv)$/i.test(t);async function at({subfolder:t="",page:s=1,perPage:a=50,exts:r=Mt}={}){const o=new URLSearchParams({subfolder:t,page:String(s),per_page:String(a),exts:r}),l=await fetch(`/cozygen/input?${o.toString()}`);if(!l.ok)throw new Error(`Input list failed: ${l.status}`);return l.json()}const Qe=t=>`/cozygen/input/file?path=${encodeURIComponent(t)}`,ut="output::",st=(t="")=>t.replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,""),Tt=(t="")=>{const s=t.replace(/\\/g,"/").split("/").filter(Boolean);return s[s.length-1]||""},is=({subfolder:t="",filename:s=""}={})=>{const a=Tt(s);if(!a)return"";const r=st(t);return`${ut}${r}::${a}`},dt=(t="")=>{if(typeof t!="string"||!t.startsWith(ut))return null;const s=t.slice(ut.length);if(!s)return null;const a=s.lastIndexOf("::"),r=a===-1?s:s.slice(a+2);return r?{subfolder:a===-1?"":s.slice(0,a),filename:r}:null},Ze=({filename:t="",subfolder:s="",type:a="output"}={})=>{const r=Tt(t);return r?`/view?${new URLSearchParams({filename:r,subfolder:st(s),type:a||"output"}).toString()}`:""},mt=(t="")=>t.split("/").slice(0,-1).join("/"),cs=t=>{if(typeof t!="string"||!t)return t!=null&&t.path?mt(t.path):"";const s=dt(t);return s?st(s.subfolder):mt(t)},jt=(t=[])=>t.map(s=>{const a=s.rel_path||s.name||"",r=s.name||a||"Untitled",o=!!s.is_dir,l=o?"":Qe(a);return{...s,name:r,rel_path:a,is_dir:o,is_image:!o&&xt(r),is_video:!o&&Dt(r),source:"input",preview_url:l}}),us=(t=[])=>t.map(s=>{const a=s.filename||"",r=s.subfolder||"",o=s.type==="directory",l=o?r||a:[r,a].filter(Boolean).join("/"),c=a||r||l||"Untitled",d=o?"":Ze({filename:a,subfolder:r,type:s.type});return{...s,name:c,rel_path:l,is_dir:o,is_image:!o&&xt(a),is_video:!o&&Dt(a),source:"output",preview_url:d}}),De={get(t,s){try{return(typeof window<"u"?JSON.parse(localStorage.getItem(t)):null)??s}catch{return s}},set(t,s){try{typeof window<"u"&&localStorage.setItem(t,JSON.stringify(s))}catch{}}};function ds({input:t,value:s,onFormChange:a}){var k;const r=((k=t==null?void 0:t.inputs)==null?void 0:k.param_name)||"Image Input",o=(t==null?void 0:t.class_type)||"CozyGenImageInput",l=`cg_last_input_cwd::${r}`,c=`cg_last_picker_source::${r}`,[d,y]=n.useState(""),[g,S]=n.useState(!1),[N,R]=n.useState(!1),[$,O]=n.useState(De.get(l,"")),[V,D]=n.useState(1),[w,P]=n.useState(50),[W,ee]=n.useState([]),[oe,M]=n.useState(1),[J,B]=n.useState(!1),[x,te]=n.useState(""),[I,ue]=n.useState([]),[re,xe]=n.useState(!0),[ne,fe]=n.useState(()=>De.get(c,"inputs")==="outputs"?"outputs":"inputs"),K=ne,G=n.useCallback(v=>{const p=v==="outputs"?"outputs":"inputs";fe(p),De.set(c,p),O(""),D(1)},[]),C=n.useMemo(()=>{if(d)try{const v=new URL(d,window.location.origin);return(v.searchParams.get("path")||v.searchParams.get("filename")||v.pathname.split("/").pop()||"").split("/").pop()||"No file selected."}catch{}if(!s)return"No file selected.";if(typeof s=="string"){const v=dt(s);return v!=null&&v.filename?v.filename.split("/").pop():s.split("/").pop()}return s!=null&&s.path?s.path.split("/").pop():"No file selected."},[d,s]);n.useEffect(()=>{if(typeof s=="string"&&s){const v=dt(s);v!=null&&v.filename?y(Ze({filename:v.filename,subfolder:v.subfolder,type:"output"})):y(Qe(s)),S(!1)}else s!=null&&s.url?(y(s.url),S(!1)):(y(""),S(!1))},[s]);const m=n.useCallback(async v=>{const p=await Wt(v),z=`/view?filename=${p.filename}&type=input`;y(z),S(!1),De.set(l,""),o==="CozyGenImageInput"?a(r,p.filename):a(r,{source:"Upload",path:p.filename,url:z})},[o,a,r]),u=n.useCallback(()=>{y(""),S(!1),o==="CozyGenImageInput"?a(r,""):a(r,{source:"Upload",path:"",url:""})},[o,a,r]),E=n.useCallback(()=>{const p=cs(s)||De.get(l,"");O(p),D(1),R(!0)},[s]),T=n.useCallback(()=>{R(!1)},[]);n.useEffect(()=>{if(N){if(K!=="inputs"){ue([]);return}(async()=>{try{const v=await at({subfolder:"",page:1,perPage:0,exts:""});ue((v.items||[]).filter(p=>p.is_dir))}catch{}})()}},[N,K]),n.useEffect(()=>{if(!N)return;let v=!1;async function p(){B(!0);try{if(K==="outputs"){const z=await Gt($,V,w);if(v)return;const U=us(z&&z.items||[]);v||(ee(U),M(z&&z.total_pages||1))}else{const U=await at({subfolder:$,page:V,perPage:w,exts:re?Mt:""}),pe=(U.items||[]).some(se=>!se.is_dir);if(re&&!pe){const se=await at({subfolder:$,page:V,perPage:w,exts:""});v||(ee(jt(se.items||[])),M(se.total_pages||1),xe(!1));return}v||(ee(jt(U.items||[])),M(U.total_pages||1))}}catch(z){console.error(K==="outputs"?"Failed to load output directory":"Failed to load input directory",z),v||(ee([]),M(1))}finally{v||B(!1)}}return p(),()=>{v=!0}},[N,$,V,w,re,K]);const A=n.useMemo(()=>{const v=x.trim().toLowerCase();let p=W;return re&&(p=p.filter(z=>{if(z.is_dir)return!0;const U=z.name||z.filename||z.rel_path||"";return xt(String(U))})),v?p.filter(z=>(z.name||z.filename||z.rel_path||"").toLowerCase().includes(v)):p},[W,x,re]),q=n.useCallback(v=>{if(!v)return;const p=typeof v=="object"?v:null;if(((p==null?void 0:p.source)||"inputs")==="output"){const se=is({subfolder:(p==null?void 0:p.subfolder)||"",filename:(p==null?void 0:p.filename)||(p==null?void 0:p.name)||""});if(!se)return;const ye=(p==null?void 0:p.preview_url)||Ze({filename:p==null?void 0:p.filename,subfolder:p==null?void 0:p.subfolder,type:p==null?void 0:p.type});y(ye),S(!1),De.set(l,st((p==null?void 0:p.subfolder)||"")),o==="CozyGenImageInput"?a(r,se):a(r,{source:"OutputGallery",path:se,url:ye}),R(!1);return}const U=typeof v=="string"?v:(p==null?void 0:p.rel_path)||(p==null?void 0:p.path)||"";if(!U)return;const pe=(p==null?void 0:p.preview_url)||Qe(U);y(pe),S(!1),De.set(l,mt(U)),o==="CozyGenImageInput"?a(r,U):a(r,{source:"Server",path:U,url:pe}),R(!1)},[o,a,r]);return{param:r,previewUrl:d,imgReady:g,setImgReady:S,displayName:C,serverOpen:N,openServer:E,closeServer:T,cwd:$,setCwd:O,page:V,setPage:D,perPage:w,setPerPage:P,totalPages:oe,loading:J,search:x,setSearch:te,topDirs:I,imagesOnly:re,setImagesOnly:xe,shownEntries:A,pickerSource:K,setPickerSource:G,handleUpload:m,clearImage:u,selectServer:q}}function ms({open:t,cwd:s,setCwd:a,page:r,setPage:o,perPage:l,setPerPage:c,totalPages:d,topDirs:y,loading:g,imagesOnly:S,setImagesOnly:N,search:R,setSearch:$,shownEntries:O,onSelect:V,onClose:D,pickerSource:w,setPickerSource:P}){if(!t)return null;const W=w||"inputs",ee=typeof P=="function",oe=()=>{a(""),o(1)},M=x=>{ee&&x!==W&&(P(x),a(""),o(1))},J=s.split("/").filter(Boolean),B=W==="outputs"?"Choose output":"Choose input";return e.jsx(Te,{open:t,onClose:D,title:B,variant:"fullscreen",footer:e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx("button",{type:"button",className:"ui-button is-muted w-full",disabled:r<=1||g,onClick:()=>o(x=>Math.max(1,x-1)),children:"Prev"}),e.jsxs("div",{className:"text-xs text-center text-[rgba(159,178,215,0.75)] min-w-[92px]",children:[r," / ",d]}),e.jsx("button",{type:"button",className:"ui-button is-muted w-full",disabled:r>=d||g,onClick:()=>o(x=>x<d?x+1:x),children:"Next"})]}),children:e.jsxs("div",{className:"sheet-stack",children:[e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Location"}),e.jsxs("div",{className:"imagepicker-breadcrumb",children:[e.jsx("button",{type:"button",className:"imagepicker-crumb",onClick:oe,children:"Root"}),J.map((x,te)=>{const I=J.slice(0,te+1).join("/");return e.jsx("button",{type:"button",className:"imagepicker-crumb",onClick:()=>{a(I),o(1)},children:x},I)})]})]}),ee?e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Source"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:`ui-button is-compact ${W==="inputs"?"is-primary":"is-muted"}`,onClick:()=>M("inputs"),children:"Inputs"}),e.jsx("button",{type:"button",className:`ui-button is-compact ${W==="outputs"?"is-primary":"is-muted"}`,onClick:()=>M("outputs"),children:"Outputs"})]})]}):null,e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Filters"}),e.jsxs("div",{className:"composer-filters",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:x=>{N(x.target.checked),o(1)}}),e.jsx("span",{className:"text-sm text-[rgba(159,178,215,0.85)]",children:"Images only"})]}),e.jsx("input",{type:"search",value:R,onChange:x=>$(x.target.value),placeholder:"Search files…",className:"sheet-input ui-control ui-input"}),e.jsxs("select",{className:"sheet-select ui-control ui-select",value:l,onChange:x=>{const te=parseInt(x.target.value,10)||50;c(te),o(1)},"aria-label":"Items per page",children:[e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]})]})]}),y.length>0?e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Quick folders"}),e.jsxs("div",{className:"imagepicker-chips",children:[e.jsx("button",{type:"button",className:`gallery-pill ${s===""?"is-active":""}`,onClick:oe,children:"Root"}),y.map(x=>e.jsx("button",{type:"button",className:`gallery-pill ${s===x.rel_path?"is-active":""}`,onClick:()=>{a(x.rel_path),o(1)},children:x.name},x.rel_path))]})]}):null,e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Results"}),g?e.jsxs("div",{className:"sheet-hint",children:["Scanning ",W==="outputs"?"output":"input"," folders…"]}):O.length===0?e.jsx("div",{className:"sheet-hint",children:"Nothing here yet. Try a different folder or turn off “Images only”."}):null,e.jsx("div",{className:"imagepicker-grid",children:!g&&O.map(x=>{const te=`${x.source||"input"}::${x.rel_path||x.name}`,I=x.is_dir?"":x.preview_url||(x.source==="output"?Ze({filename:x.filename,subfolder:x.subfolder,type:x.type}):Qe(x.rel_path||""));return e.jsx("button",{type:"button",className:`imagepicker-item ${x.is_dir?"is-dir":""}`,onClick:()=>{x.is_dir?(a(x.rel_path||""),o(1)):V(x)},children:x.is_dir?e.jsxs("div",{className:"imagepicker-dir-row",children:[e.jsx("div",{className:"imagepicker-dir-dot","aria-hidden":"true"}),e.jsx("div",{className:"imagepicker-name",children:x.name})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"imagepicker-thumb",children:I?e.jsx("img",{className:"imagepicker-img",alt:x.name,src:I}):e.jsx("div",{className:"imagepicker-img is-placeholder"})}),e.jsx("div",{className:"imagepicker-name",children:x.name})]})},te)})})]})]})})}function fs({open:t,onClose:s,title:a,url:r,kind:o="image"}){return r?e.jsx(Te,{open:t,onClose:s,title:a||"Preview",variant:"fullscreen",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:r,target:"_blank",rel:"noreferrer",className:"ui-button is-muted w-full text-center",children:"Open"}),e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:s,children:"Close"})]}),children:e.jsx("div",{className:"url-viewer-stage",children:o==="video"?e.jsx("video",{src:r,controls:!0,className:"url-viewer-media",autoPlay:!0}):e.jsx("img",{src:r,alt:a||"Preview",className:"url-viewer-media"})})}):null}function ps({input:t,value:s,onFormChange:a}){const{previewUrl:r,imgReady:o,setImgReady:l,displayName:c,serverOpen:d,openServer:y,closeServer:g,cwd:S,setCwd:N,page:R,setPage:$,perPage:O,setPerPage:V,totalPages:D,topDirs:w,loading:P,search:W,setSearch:ee,imagesOnly:oe,setImagesOnly:M,shownEntries:J,pickerSource:B,setPickerSource:x,handleUpload:te,clearImage:I,selectServer:ue}=ds({input:t,value:s,onFormChange:a}),re=n.useRef(null),xe=n.useRef(null),[ne,fe]=n.useState(0),[K,G]=n.useState(!1);n.useEffect(()=>{const u=xe.current;if(!u)return;const E=A=>{A.preventDefault(),A.stopPropagation()},T=async A=>{var k,v;E(A);const q=(v=(k=A.dataTransfer)==null?void 0:k.files)==null?void 0:v[0];q&&(await te(q),re.current&&(re.current.value=""),fe(p=>p+1))};return["dragenter","dragover","dragleave","drop"].forEach(A=>u.addEventListener(A,A==="drop"?T:E)),()=>{["dragenter","dragover","dragleave","drop"].forEach(A=>u.removeEventListener(A,A==="drop"?T:E))}},[te]);const C=async u=>{var T;const E=(T=u.target.files)==null?void 0:T[0];E&&(await te(E),re.current&&(re.current.value=""),fe(A=>A+1))},m=()=>{re.current&&re.current.click()};return e.jsxs("div",{className:"asset-card",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-[#F8F4FF] truncate",children:c}),e.jsx("span",{className:"text-[11px] text-[#C3C7FFB3] truncate",children:"Image"})]}),e.jsx("div",{ref:xe,className:"mb-3 rounded-xl border border-dashed border-[rgba(255,255,255,0.14)] bg-[rgba(255,255,255,0.02)] flex items-center justify-center min-h-[140px] sm:min-h-[180px] overflow-hidden",children:r?e.jsx("button",{type:"button",className:"asset-preview-btn",onClick:()=>G(!0),"aria-label":`Preview ${c}`,title:"Open preview",children:e.jsx("img",{src:r,alt:c,className:`max-h-64 max-w-full object-contain transition-opacity ${o?"opacity-100":"opacity-0"}`,onLoad:()=>l(!0)})}):e.jsx("div",{className:"text-[11px] text-[#9DA3FFCC] text-center px-6",children:"Drop an image here, upload from your device, or choose one from your server."})}),e.jsx("input",{ref:re,type:"file",accept:"image/*",className:"hidden",onChange:C},ne),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("button",{type:"button",className:"ui-button is-primary is-compact",onClick:y,children:"Choose"}),e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:m,children:"Upload"}),e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:I,children:"Clear"})]}),e.jsx(ms,{open:d,cwd:S,setCwd:N,page:R,setPage:$,perPage:O,setPerPage:V,totalPages:D,topDirs:w,loading:P,imagesOnly:oe,setImagesOnly:M,search:W,setSearch:ee,shownEntries:J,pickerSource:B,setPickerSource:x,onSelect:ue,onClose:g}),e.jsx(fs,{open:K,onClose:()=>G(!1),title:c||"Preview",url:r,kind:"image"})]})}function hs({open:t,onClose:s,title:a,description:r,render:o,index:l=0,total:c=0,children:d}){const[y,g]=n.useState("idle");if(n.useEffect(()=>{if(y==="queued"){const N=setTimeout(()=>g("idle"),1600);return()=>clearTimeout(N)}},[y]),!t)return null;const S=typeof o=="function"?o():d;return e.jsxs("div",{className:"spotlight-overlay",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"spotlight-backdrop",onClick:s}),e.jsxs("div",{className:"spotlight-sheet",children:[e.jsxs("div",{className:"spotlight-header",children:[e.jsxs("div",{className:"spotlight-meta",children:[e.jsx("div",{className:"spotlight-kicker",children:"Focused control"}),e.jsx("div",{className:"spotlight-title",children:a||"Control"}),r?e.jsx("div",{className:"spotlight-hint",children:r}):null]}),e.jsx("button",{type:"button",className:"spotlight-close",onClick:s,"aria-label":"Close",children:"×"})]}),e.jsx("div",{className:"spotlight-body",children:S}),e.jsx("div",{className:"spotlight-footer",children:e.jsx("div",{className:"spotlight-footer-right",children:e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:s,"aria-label":"Close",children:"Close"})})})]})]})}function Re(t){const s=Number(t);return Number.isFinite(s)?s.toFixed(2).replace(/\.?0+$/u,""):"1"}function Ne(t="",s){if(!s||typeof s.index!="number"||typeof s.length!="number")return null;const a=String(t||""),r=s.index,o=s.index+s.length;if(r<=0||a[r-1]!=="("||a[o]!==":")return null;let l=o+1,c="";for(;l<a.length&&a[l]!==")";)if(c+=a[l],l+=1,c.length>12)return null;if(l>=a.length||a[l]!==")")return null;const d=c.trim();if(!/^\d+(\.\d+)?$/u.test(d))return null;const y=Number.parseFloat(d);return Number.isFinite(y)?{weight:y,wrapperStart:r-1,wrapperEnd:l+1}:null}function Oe(t="",s,a){const r=String(t||"");if(!s||typeof s.index!="number"||typeof s.length!="number")return r;const o=s.index,l=s.index+s.length,c=Ne(r,s),d=a==null?null:Number(a),y=d===null||!Number.isFinite(d)||Math.abs(d-1)<1e-6;if(c){if(y)return r.slice(0,c.wrapperStart)+r.slice(o,l)+r.slice(c.wrapperEnd);const S=Re(d);return r.slice(0,l+1)+S+r.slice(c.wrapperEnd-1)}if(y)return r;const g=Re(d);return r.slice(0,o)+"("+r.slice(o,l)+":"+g+")"+r.slice(l)}function Ke(t,s,a){const r=Number(t);return Number.isFinite(r)?Math.max(s,Math.min(a,r)):s}function ft({open:t,onClose:s,title:a="Alias strength",tokenLabel:r="",weight:o=1,onApply:l,onRemoveWeight:c,onDeleteToken:d}){const y=n.useMemo(()=>Ke(o||1,.2,2),[o]),[g,S]=n.useState(y);n.useEffect(()=>{t&&S(y)},[t,y]);const N=Re(g);return e.jsx(Te,{open:t,onClose:s,title:a,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"ui-button is-muted w-full",onClick:s,children:"Cancel"}),e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:()=>{l==null||l(g),s==null||s()},children:"Done"})]}),children:e.jsxs("div",{className:"sheet-stack",children:[e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Alias"}),e.jsx("div",{className:"sheet-hint",children:r||"—"})]}),e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Strength"}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>S(R=>Ke(R-.05,.2,2)),children:"−"}),e.jsxs("div",{className:"text-sm text-[rgba(237,242,255,0.92)] tabular-nums",children:[N,"×"]}),e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>S(R=>Ke(R+.05,.2,2)),children:"+"})]}),e.jsx("input",{type:"range",min:.2,max:2,step:.05,value:g,onChange:R=>S(Ke(R.target.value,.2,2)),className:"w-full","aria-label":"Alias strength"}),e.jsx("div",{className:"sheet-hint",children:"1.0× is normal. Increase to emphasize or reduce to soften."})]}),e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Actions"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:()=>S(1),children:"Reset to 1.0×"}),e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:()=>{c==null||c(),s==null||s()},children:"Remove strength"}),e.jsx("button",{type:"button",className:"ui-button is-danger is-compact",onClick:()=>{d==null||d(),s==null||s()},children:"Remove alias"})]})]})]})})}function gs({open:t,onClose:s,value:a="",onChange:r,aliasOptions:o=[],aliasCatalog:l=[],aliasLookup:c,fieldLabel:d="Prompt"}){var Ce;const y=n.useRef(null),g=n.useRef(null),S=n.useRef(null),[N,R]=n.useState(a),[$,O]=n.useState(""),[V,D]=n.useState("All"),[w,P]=n.useState("All"),[W,ee]=n.useState(30),[oe,M]=n.useState("compose"),[J,B]=n.useState(null),[x,te]=n.useState(null),I=n.useRef(null),ue=n.useRef(null),[re,xe]=n.useState(!1),[ne,fe]=n.useState(null);n.useEffect(()=>{t&&(R(a),M("compose"),O(""),D("All"),P("All"),ee(30),B(null),te(null),xe(!1),fe(null))},[t,a]);const K=n.useMemo(()=>(Array.isArray(l)?l.filter(f=>f&&f.name):[]).map(f=>({...f,...gt(f)})),[l]),G=n.useMemo(()=>{const f=new Map;return K.forEach(j=>{j!=null&&j.token&&f.set(String(j.token).toLowerCase(),j)}),f},[K]),C=n.useMemo(()=>{const f=new Set(["All"]);return K.forEach(j=>{j.category&&f.add(j.category)}),Array.from(f).sort((j,F)=>j.localeCompare(F))},[K]),m=n.useMemo(()=>{const f=new Set(["All"]);return K.forEach(j=>{(!V||V==="All"||j.category===V)&&j.subcategory&&f.add(j.subcategory)}),Array.from(f).sort((j,F)=>j.localeCompare(F))},[K,V]),u=n.useMemo(()=>["All",...C.filter(f=>f!=="All")],[C]),E=n.useMemo(()=>["All",...m.filter(f=>f!=="All")],[m]),T=n.useMemo(()=>{const f=$.trim().toLowerCase();return K.filter(j=>{var F,b,_,X;return V!=="All"&&(j.category||"")!==V||w!=="All"&&(j.subcategory||"other")!==w?!1:f?((F=j.token)==null?void 0:F.toLowerCase().includes(f))||((b=j.text)==null?void 0:b.toLowerCase().includes(f))||((_=j.name)==null?void 0:_.toLowerCase().includes(f))||((X=j.displayName)==null?void 0:X.toLowerCase().includes(f)):!0}).sort((j,F)=>{const b=(j.subcategory||"").toLowerCase(),_=(F.subcategory||"").toLowerCase();return b!==_?b.localeCompare(_):j.token.localeCompare(F.token)})},[K,V,w,$]),A=n.useMemo(()=>T.slice(0,W),[T,W]);n.useEffect(()=>{ee(30)},[V,w,$,K]),n.useEffect(()=>{P("All")},[V]),n.useEffect(()=>{const f=S.current;if(!f)return;const j=new IntersectionObserver(F=>{F[0].isIntersecting&&W<T.length&&ee(_=>Math.min(_+20,T.length))},{threshold:.1});return j.observe(f),()=>j.disconnect()},[W,T.length]);const q=n.useMemo(()=>{if(oe!=="compose")return[];if(typeof N!="string")return[];const f=[],j=/\$([a-z0-9_:-]+)\$/gi;let F;for(;F=j.exec(N);)f.push({token:F[1],index:F.index,length:F[0].length});return f},[oe,N]),k=n.useDeferredValue(N),v=n.useMemo(()=>{const j=b=>b&&b.length>2600?`${b.slice(0,2600)}…`:b;if(oe!=="compose")return"";const F=k||"";if(!F)return"";if(!c||!F.includes("$"))return j(F);try{const b=F.replace(/\$([a-z0-9_:-]+)\$/gi,(_,X)=>{const Y=c.get(X.toLowerCase());return typeof Y=="string"?Y:_});return j(b)}catch{return j(F)}},[oe,k,c]),p=f=>{R(f.target.value)},z=f=>{const j=y.current,F=`$${f}$`,b=N||"",_=(j==null?void 0:j.selectionStart)??b.length,X=(j==null?void 0:j.selectionEnd)??b.length,Y=b.slice(0,_),ce=b.slice(X),le=Y.match(/[^\s]$/),H=ce.match(/^[^\s]/),i=le&&le[0]!==","?", ":"",h=H&&H[0]!==","?", ":"",L=Y+i+F+h+ce;R(L);const Q=(Y+i+F+h).length;requestAnimationFrame(()=>{var Z;try{(Z=j==null?void 0:j.setSelectionRange)==null||Z.call(j,Q,Q)}catch{}})},U=f=>{const j=N||"",F=Ne(j,f),b=F?F.wrapperStart:f.index,_=F?F.wrapperEnd:f.index+f.length,X=j.slice(0,b).replace(/[\s,]*$/,""),Y=j.slice(_).replace(/^[\s,]*/,""),ce=X?`${X} ${Y}`.trim():Y.trim();R(ce)},pe=f=>{if(!f)return;const j=G.get(f.token.toLowerCase()),F=(j==null?void 0:j.displayName)||f.token,b=Ne(N||"",f);fe({tokenObj:f,displayName:F,weight:(b==null?void 0:b.weight)??1}),xe(!0)},se=n.useCallback((f,j)=>{if(f===j||f===null||j===null)return;const F=N||"",b=q[0],_=q[q.length-1],X=b?Ne(F,b):null,Y=_?Ne(F,_):null,ce=b?F.slice(0,X?X.wrapperStart:b.index).replace(/[\s,]*$/,""):"",le=_?F.slice(Y?Y.wrapperEnd:_.index+_.length).replace(/^[\s,]*/,""):"",H=[...q],[i]=H.splice(f,1);H.splice(j,0,i);const L=H.map(Z=>{const me=Ne(F,Z);return me?F.slice(me.wrapperStart,me.wrapperEnd):F.slice(Z.index,Z.index+Z.length)||`$${Z.token}$`}).join(", ");let Q="";ce?Q=`${ce}, ${L}`:Q=L,le&&(Q=`${Q}, ${le}`),R(Q.trim())},[N,q]),ye=n.useCallback((f,j)=>{B(j),I.current=f.target,f.dataTransfer.effectAllowed="move",f.dataTransfer.setData("text/plain",j.toString()),requestAnimationFrame(()=>{I.current&&I.current.classList.add("is-dragging")})},[]),de=n.useCallback(()=>{I.current&&I.current.classList.remove("is-dragging"),J!==null&&x!==null&&J!==x&&se(J,x),B(null),te(null),I.current=null},[J,x,se]),he=n.useCallback((f,j)=>{f.preventDefault(),f.dataTransfer.dropEffect="move",j!==x&&te(j)},[x]),ae=n.useCallback(()=>{},[]),ge=n.useCallback((f,j)=>{f.preventDefault();const F=f.touches[0];ue.current={idx:j,startX:F.clientX,startY:F.clientY,moved:!1}},[]),be=n.useCallback(f=>{if(!ue.current)return;const j=f.touches[0],F=Math.abs(j.clientX-ue.current.startX),b=Math.abs(j.clientY-ue.current.startY);if(F>10||b>10){ue.current.moved=!0,B(ue.current.idx),f.preventDefault();const _=document.querySelectorAll(".composer-token-draggable"),X=j.clientX,Y=j.clientY;for(let ce=0;ce<_.length;ce++){const le=_[ce].getBoundingClientRect();if(X>=le.left&&X<=le.right&&Y>=le.top&&Y<=le.bottom){te(ce);break}}}},[]),we=n.useCallback(()=>{var f;(f=ue.current)!=null&&f.moved&&J!==null&&x!==null&&J!==x&&se(J,x),ue.current=null,B(null),te(null)},[J,x,se]),Ie=()=>{r==null||r(N),s==null||s()},Se=()=>{s==null||s()};return t?e.jsxs(Te,{open:t,onClose:Se,title:"Composer",variant:"fullscreen",shouldCloseOnOverlayClick:!1,shouldCloseOnEsc:!1,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"ui-button is-muted w-full",onClick:Se,children:"Cancel"}),e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:Ie,children:"Apply"})]}),children:[e.jsxs("div",{className:"composer-shell",children:[e.jsxs("div",{className:"composer-subhead",children:[e.jsx("div",{className:"sheet-label",children:"Editing"}),e.jsx("div",{className:"composer-field",children:d})]}),e.jsxs("div",{className:"composer-tabs",role:"tablist","aria-label":"Composer tabs",children:[e.jsx("button",{type:"button",role:"tab","aria-selected":oe==="compose",className:`composer-tab ${oe==="compose"?"is-active":""}`,onClick:()=>M("compose"),children:"Compose"}),e.jsxs("button",{type:"button",role:"tab","aria-selected":oe==="aliases",className:`composer-tab ${oe==="aliases"?"is-active":""}`,onClick:()=>M("aliases"),children:["Aliases",K.length>0&&e.jsx("span",{className:"composer-tab-badge",children:K.length})]})]}),e.jsxs("div",{className:`composer-panel composer-panel-compose ${oe==="compose"?"is-visible":""}`,children:[e.jsx("div",{className:"composer-textarea-wrap",children:e.jsx("textarea",{ref:y,value:N,onChange:p,placeholder:"Compose your prompt… Use $category:alias$ tokens to insert aliases.",className:"composer-textarea",rows:8})}),q.length>0&&e.jsxs("div",{className:"composer-tokens",children:[e.jsxs("div",{className:"composer-tokens-label",children:["Active aliases ",e.jsx("span",{className:"composer-tokens-hint",children:"(drag to reorder)"})]}),e.jsx("div",{className:"composer-tokens-list",children:q.map((f,j)=>{var ce;const F=G.get(f.token.toLowerCase()),b=(F==null?void 0:F.displayName)||f.token,_=J===j,X=x===j&&J!==null&&J!==j,Y=((ce=Ne(N||"",f))==null?void 0:ce.weight)??1;return e.jsxs("span",{className:`composer-token composer-token-draggable ${_?"is-dragging":""} ${X?"is-drop-target":""}`,title:`$${f.token}$`,draggable:!0,onDragStart:le=>ye(le,j),onDragEnd:de,onDragOver:le=>he(le,j),onDragLeave:ae,onTouchStart:le=>ge(le,j),onTouchMove:be,onTouchEnd:we,onClick:()=>{J===null&&pe(f)},children:[e.jsx("span",{className:"composer-token-drag-handle","aria-hidden":"true",children:e.jsx(it,{size:14})}),e.jsx("span",{className:"composer-token-name",children:b}),Math.abs(Y-1)>1e-6?e.jsxs("span",{className:"composer-token-weight","aria-label":`Strength ${Re(Y)}x`,children:["×",Re(Y)]}):null,e.jsx("button",{type:"button",className:"composer-token-remove",onClick:le=>{le.stopPropagation(),U(f)},"aria-label":`Remove ${f.token}`,children:e.jsx(ct,{size:12})})]},`${f.token}-${f.index}`)})})]}),e.jsxs("div",{className:"composer-preview",children:[e.jsx("div",{className:"composer-preview-label",children:"Expanded prompt"}),e.jsx("div",{className:"composer-preview-content",children:v||"—"})]})]}),e.jsxs("div",{className:`composer-panel composer-panel-aliases ${oe==="aliases"?"is-visible":""}`,children:[e.jsxs("div",{className:"composer-filters",children:[e.jsx("input",{ref:g,type:"text",value:$,onChange:f=>O(f.target.value),placeholder:"Search aliases…",className:"composer-search ui-control ui-input"}),e.jsx("select",{value:V,onChange:f=>D(f.target.value),className:"composer-subcategory-select ui-control ui-select is-compact","aria-label":"Filter by category",children:u.map(f=>e.jsx("option",{value:f,children:f==="All"?"Category: All":Je(f)},`cat-${f}`))}),E.length>2&&e.jsx("select",{value:w,onChange:f=>P(f.target.value),className:"composer-subcategory-select ui-control ui-select is-compact",children:E.map(f=>e.jsx("option",{value:f,children:f==="All"?"All subcategories":Lt(f)},f))})]}),e.jsx("div",{className:"composer-alias-list",children:T.length===0?e.jsx("div",{className:"composer-alias-empty",children:"No aliases found."}):e.jsxs(e.Fragment,{children:[A.map(f=>e.jsxs("button",{type:"button",onClick:()=>z(f.token),className:"composer-alias-item",children:[e.jsxs("div",{className:"composer-alias-header",children:[e.jsx("div",{className:"composer-alias-name",children:f.displayName||f.token}),f.category?e.jsx("span",{className:"composer-alias-category",children:Je(f.category)}):null]}),e.jsxs("div",{className:"composer-alias-token",children:["$",f.token,"$"]}),e.jsx("div",{className:"composer-alias-text",children:f.text})]},f.key)),W<T.length&&e.jsx("div",{ref:S,className:"composer-sentinel"})]})})]})]}),e.jsx(ft,{open:re,onClose:()=>xe(!1),title:"Alias strength",tokenLabel:ne?`${ne.displayName} • $${(Ce=ne.tokenObj)==null?void 0:Ce.token}$`:"",weight:(ne==null?void 0:ne.weight)??1,onApply:f=>{ne!=null&&ne.tokenObj&&R(j=>Oe(j||"",ne.tokenObj,f))},onRemoveWeight:()=>{ne!=null&&ne.tokenObj&&R(f=>Oe(f||"",ne.tokenObj,null))},onDeleteToken:()=>{ne!=null&&ne.tokenObj&&U(ne.tokenObj)}})]}):null}function xs({open:t,onClose:s,title:a,value:r,onChange:o,placeholder:l="",description:c}){const d=a||"Edit",y=n.useMemo(()=>`sheet-textarea-${Math.random().toString(36).slice(2,9)}`,[]);return e.jsxs(Te,{open:t,onClose:s,title:d,variant:"fullscreen",footer:e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:s,children:"Done"}),children:[c?e.jsx("div",{className:"text-[12px] text-[rgba(159,178,215,0.75)] mb-3",children:c}):null,e.jsx("textarea",{id:y,value:r??"",onChange:g=>o==null?void 0:o(g.target.value),placeholder:l,className:"sheet-textarea ui-control ui-textarea",rows:12})]})}function bs({name:t,label:s,description:a,value:r,onChange:o,onEnter:l,disabled:c=!1,multiline:d=!1,aliasOptions:y=[],aliasCatalog:g=[],onOpenComposer:S}){var le,H;const N=n.useRef(null),R=n.useRef(null),$=n.useRef({start:null,end:null}),O=n.useRef(null),V=n.useRef(null),[D,w]=n.useState(null),[P,W]=n.useState(null),[ee,oe]=n.useState(!1),[M,J]=n.useState(""),[B,x]=n.useState("All"),[te,I]=n.useState("All"),[ue]=n.useState([]),re=n.useRef(null),[xe,ne]=n.useState(!1),[fe,K]=n.useState(!1),[G,C]=n.useState(null),m=typeof r=="string"?r:String(r??"");n.useMemo(()=>Array.isArray(y)?y.filter(Boolean):[],[y]);const u=n.useMemo(()=>(Array.isArray(g)?g.filter(i=>i&&i.name):[]).map(i=>({...i,...gt(i)})),[g]),E=n.useMemo(()=>u,[u]),T=i=>{const h=i.target.value;o==null||o(h)},A=i=>{if(!d&&i.key==="Enter"){i.preventDefault(),l==null||l(i.target.value,i);return}},q=n.useMemo(()=>{const i=new Map;return E.forEach(h=>{h!=null&&h.token&&i.set(String(h.token).toLowerCase(),h)}),i},[E]),k=n.useMemo(()=>{const i=new Set(["All"]);return u.forEach(h=>{h.category&&i.add(h.category)}),Array.from(i).sort((h,L)=>h.localeCompare(L))},[u]),v=n.useMemo(()=>{const i=new Set(["All"]);return E.forEach(h=>{(!B||B==="All"||h.category===B)&&h.subcategory&&i.add(h.subcategory)}),Array.from(i).sort((h,L)=>h.localeCompare(L))},[E,B]);n.useEffect(()=>{I("All")},[B]);const p=n.useMemo(()=>{const i=m||"";if(!i||!i.includes("$"))return[];const h=[],L=/\$([a-z0-9_:-]+)\$/gi;let Q;for(;Q=L.exec(i);)h.push({token:Q[1],index:Q.index,length:Q[0].length});return h},[m]);n.useEffect(()=>{ee&&re.current&&requestAnimationFrame(()=>{var i;return(i=re.current)==null?void 0:i.focus({preventScroll:!0})})},[ee]);const z=()=>{try{const i=N.current;i?$.current={start:i.selectionStart??null,end:i.selectionEnd??null}:$.current={start:null,end:null}}catch{$.current={start:null,end:null}}R.current&&R.current.scrollIntoView({block:"center",behavior:"smooth"}),oe(!0)},U=n.useMemo(()=>{const i=M.trim().toLowerCase();return E.filter(h=>{var L,Q,Z,me;return B!=="All"&&(h.category||"")!==B||te!=="All"&&(h.subcategory||"other")!==te?!1:i?((L=h.token)==null?void 0:L.toLowerCase().includes(i))||((Q=h.text)==null?void 0:Q.toLowerCase().includes(i))||((Z=h.name)==null?void 0:Z.toLowerCase().includes(i))||((me=h.displayName)==null?void 0:me.toLowerCase().includes(i)):!0}).sort((h,L)=>{const Q=(h.subcategory||"").toLowerCase(),Z=(L.subcategory||"").toLowerCase();return Q!==Z?Q.localeCompare(Z):h.token.localeCompare(L.token)})},[E,B,te,M]),[pe,se]=n.useState(30),ye=n.useMemo(()=>U.slice(0,pe),[U,pe]);n.useEffect(()=>{se(30)},[B,te,M,u]),n.useEffect(()=>{I("All")},[B]);const de=(i,{closeAfter:h=!0}={})=>{var yt,wt;const L=N.current,Q=`$${i}$`,Z=m||"",me=(yt=$.current)==null?void 0:yt.start,ve=(wt=$.current)==null?void 0:wt.end,je=(L==null?void 0:L.selectionStart)??(typeof me=="number"?me:Z.length),ie=(L==null?void 0:L.selectionEnd)??(typeof ve=="number"?ve:Z.length),ke=Z.slice(0,je),He=Z.slice(ie),rt=ke.match(/[^\s]$/),We=He.match(/^[^\s]/),ze=rt&&rt[0]!==","?", ":"",Me=We&&We[0]!==","?", ":"",Ge=ke+ze+Q+Me+He;o==null||o(Ge);const bt=(ke+ze+Q+Me).length;$.current={start:bt,end:bt},h&&(oe(!1),requestAnimationFrame(()=>{var vt;(vt=L==null?void 0:L.blur)==null||vt.call(L)}))},he=i=>{const h=m||"",L=Ne(h,i),Q=L?L.wrapperStart:i.index,Z=L?L.wrapperEnd:i.index+i.length,me=h.slice(0,Q).replace(/[\s,]*$/,""),ve=h.slice(Z).replace(/^[\s,]*/,""),je=me?`${me} ${ve}`.trim():ve.trim();o==null||o(je)},ae=i=>{if(!i)return;const h=q.get(i.token.toLowerCase()),L=(h==null?void 0:h.displayName)||i.token,Q=Ne(m||"",i);C({tokenObj:i,displayName:L,weight:(Q==null?void 0:Q.weight)??1}),K(!0),requestAnimationFrame(()=>{var Z,me;return(me=(Z=N.current)==null?void 0:Z.blur)==null?void 0:me.call(Z)})},ge=n.useMemo(()=>(i,h)=>{if(i===h||i===null||h===null||!(p!=null&&p.length))return;const L=m||"",Q=p[0],Z=p[p.length-1],me=Q?Ne(L,Q):null,ve=Z?Ne(L,Z):null,je=Q?L.slice(0,me?me.wrapperStart:Q.index).replace(/[\s,]*$/,""):"",ie=Z?L.slice(ve?ve.wrapperEnd:Z.index+Z.length).replace(/^[\s,]*/,""):"",ke=[...p],[He]=ke.splice(i,1);ke.splice(h,0,He);const We=ke.map(Me=>{const Ge=Ne(L,Me);return Ge?L.slice(Ge.wrapperStart,Ge.wrapperEnd):L.slice(Me.index,Me.index+Me.length)||`$${Me.token}$`}).join(", ");let ze=je?`${je}, ${We}`:We;ie&&(ze=`${ze}, ${ie}`),o==null||o(ze.trim())},[o,p,m]),be=(i,h)=>{w(h),O.current=i.currentTarget,i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",String(h)),requestAnimationFrame(()=>{O.current&&O.current.classList.add("is-dragging")})},we=(i,h)=>{i.preventDefault(),i.dataTransfer.dropEffect="move",h!==P&&W(h)},Ie=i=>{i!==P&&W(i)},Se=i=>{D!==null&&i!==null&&D!==i&&ge(D,i),w(null),W(null),O.current=null},Ce=()=>{O.current&&O.current.classList.remove("is-dragging"),Se(P)},f=(i,h)=>{i.preventDefault(),Se(h)},j=(i,h)=>{i.preventDefault();const L=i.touches[0];V.current={idx:h,startX:L.clientX,startY:L.clientY,moved:!1}},F=i=>{if(!V.current)return;const h=i.touches[0],L=Math.abs(h.clientX-V.current.startX),Q=Math.abs(h.clientY-V.current.startY);if(L<=10&&Q<=10)return;V.current.moved=!0,w(V.current.idx),i.preventDefault();const Z=R.current,me=Z?Z.querySelectorAll(".token-chip-draggable"):document.querySelectorAll(".token-chip-draggable"),ve=h.clientX,je=h.clientY;for(let ie=0;ie<me.length;ie++){const ke=me[ie].getBoundingClientRect();if(ve>=ke.left&&ve<=ke.right&&je>=ke.top&&je<=ke.bottom){W(ie);break}}},b=()=>{var i;(i=V.current)!=null&&i.moved&&D!==null&&P!==null&&D!==P&&ge(D,P),V.current=null,w(null),W(null)},_={id:t,name:t,value:m,onChange:T,disabled:c,className:"ui-control ui-input pr-10 text-[13px] sm:text-sm",placeholder:"","aria-label":s||t,"aria-describedby":a?`${t}-description`:void 0},X=()=>{oe(!1),requestAnimationFrame(()=>{var i,h;(h=(i=N.current)==null?void 0:i.blur)==null||h.call(i)})},Y=(()=>{const i=String(t||"").toLowerCase(),h=String(s||"").toLowerCase();return!!`${i} ${h}`.trim().includes("prompt")})(),ce=()=>e.jsx(Te,{open:ee,onClose:X,title:Y?"Insert alias":"Aliases",footer:e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:X,children:"Done"}),children:e.jsxs("div",{className:"sheet-stack",children:[e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Search"}),e.jsxs("div",{className:"composer-filters",children:[e.jsx("input",{ref:re,type:"text",value:M,onChange:i=>J(i.target.value),placeholder:"Search aliases…",className:"composer-search ui-control ui-input"}),e.jsx("select",{value:B,onChange:i=>x(i.target.value),className:"composer-subcategory-select ui-control ui-select is-compact","aria-label":"Filter by category",children:["All",...k.filter(i=>i!=="All")].map(i=>e.jsx("option",{value:i,children:i==="All"?"Category: All":Je(i)},`cat-${i}`))}),v.length>2?e.jsx("select",{value:te,onChange:i=>I(i.target.value),className:"composer-subcategory-select ui-control ui-select is-compact",children:v.map(i=>e.jsx("option",{value:i,children:i==="All"?"All subcategories":Lt(i)},i))}):null]})]}),e.jsxs("div",{className:"sheet-section",children:[e.jsx("div",{className:"sheet-label",children:"Results"}),e.jsx("div",{className:"composer-alias-list",children:U.length===0?e.jsx("div",{className:"composer-alias-empty",children:"No aliases found."}):e.jsxs(e.Fragment,{children:[ye.map(i=>e.jsxs("button",{type:"button",onClick:()=>de(i.token,{closeAfter:!Y}),className:"composer-alias-item",children:[e.jsxs("div",{className:"composer-alias-header",children:[e.jsx("div",{className:"composer-alias-name",children:i.displayName||i.token}),i.category?e.jsx("span",{className:"composer-alias-category",children:Je(i.category)}):null]}),e.jsxs("div",{className:"composer-alias-token",children:["$",i.token,"$"]}),e.jsx("div",{className:"composer-alias-text",children:i.text})]},i.key)),pe<U.length?e.jsxs("button",{type:"button",onClick:()=>se(i=>Math.min(i+30,U.length)),className:"ui-button is-muted w-full",children:["Show more (",U.length-pe," left)"]}):null]})})]})]})});return n.useEffect(()=>{if(!ee)return;const i=setTimeout(()=>{var h,L,Q,Z;(L=(h=re.current)==null?void 0:h.focus)==null||L.call(h),(Z=(Q=re.current)==null?void 0:Q.select)==null||Z.call(Q)},50);return()=>clearTimeout(i)},[ee]),d?e.jsxs("div",{className:"relative space-y-2",ref:R,children:[S&&!Y?e.jsxs("div",{className:"stringinput-toolbar",children:[e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>S(t),children:"Open composer"}),u.length?e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:z,children:"Aliases"}):null,e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:()=>ne(!0),children:"Expand"})]}):null,e.jsx("textarea",{ref:N,..._,rows:3,wrap:"soft",onKeyDown:A,className:_.className+" resize-none min-h-[88px] max-h-[160px] leading-relaxed overflow-y-auto overflow-x-hidden break-words whitespace-pre-wrap",style:{whiteSpace:"pre-wrap",wordBreak:"break-word",overflowWrap:"anywhere"}}),S&&Y?e.jsx("div",{className:"stringinput-underbar",children:e.jsxs("div",{className:"stringinput-underbar-actions",children:[e.jsx("button",{type:"button",className:"stringinput-action-link",onClick:()=>S(t),children:"Open composer"}),u.length?e.jsx("button",{type:"button",className:"stringinput-action-link",onClick:z,children:"Insert alias"}):null]})}):null,e.jsx(xs,{open:xe,onClose:()=>ne(!1),title:s||t,value:m,onChange:o,description:a}),p.length?e.jsxs("div",{className:"stringinput-tokens",children:[e.jsxs("div",{className:"stringinput-tokens-label",children:["Active aliases ",e.jsx("span",{className:"stringinput-tokens-hint",children:"(drag to reorder)"})]}),e.jsx("div",{className:"stringinput-tokens-list",children:p.map((i,h)=>{var je;const L=q.get(i.token.toLowerCase()),Q=(L==null?void 0:L.displayName)||i.token,Z=D===h,me=P===h&&D!==null&&D!==h,ve=((je=Ne(m||"",i))==null?void 0:je.weight)??1;return e.jsxs("div",{className:`token-chip token-chip-draggable ${Z?"is-dragging":""} ${me?"is-drop-target":""}`,title:`$${i.token}$`,role:"button",tabIndex:0,draggable:!0,onDragStart:ie=>be(ie,h),onDragEnd:Ce,onDragEnter:()=>Ie(h),onDragOver:ie=>we(ie,h),onDrop:ie=>f(ie,h),onTouchStart:ie=>j(ie,h),onTouchMove:F,onTouchEnd:b,onClick:()=>{D===null&&ae(i)},onKeyDown:ie=>{(ie.key==="Enter"||ie.key===" ")&&(ie.preventDefault(),ae(i))},children:[e.jsx("span",{className:"token-chip-drag-handle","aria-hidden":"true",children:e.jsx(it,{size:14})}),e.jsx("span",{className:"token-chip-label",children:Q}),Math.abs(ve-1)>1e-6?e.jsxs("span",{className:"token-chip-weight","aria-label":`Strength ${Re(ve)}x`,children:["×",Re(ve)]}):null,e.jsx("button",{type:"button",className:"token-chip-remove",onClick:ie=>{ie.stopPropagation(),he(i)},"aria-label":`Remove ${i.token}`,children:e.jsx(ct,{size:12})})]},`${i.token}-${i.index}`)})})]}):null,e.jsx(ft,{open:fe,onClose:()=>K(!1),title:"Alias strength",tokenLabel:G?`${G.displayName} • $${(le=G.tokenObj)==null?void 0:le.token}$`:"",weight:(G==null?void 0:G.weight)??1,onApply:i=>{G!=null&&G.tokenObj&&(o==null||o(Oe(m||"",G.tokenObj,i)))},onRemoveWeight:()=>{G!=null&&G.tokenObj&&(o==null||o(Oe(m||"",G.tokenObj,null)))},onDeleteToken:()=>{G!=null&&G.tokenObj&&he(G.tokenObj)}}),ee?e.jsx(ce,{}):null]}):e.jsxs("div",{className:"relative space-y-2",ref:R,children:[e.jsx("input",{..._,type:"text",inputMode:"text",autoComplete:"off",onKeyDown:A,className:_.className+" min-h-[44px]",ref:N}),p.length?e.jsxs("div",{className:"stringinput-tokens",children:[e.jsxs("div",{className:"stringinput-tokens-label",children:["Active aliases ",e.jsx("span",{className:"stringinput-tokens-hint",children:"(drag to reorder)"})]}),e.jsx("div",{className:"stringinput-tokens-list",children:p.map((i,h)=>{var je;const L=q.get(i.token.toLowerCase()),Q=(L==null?void 0:L.displayName)||i.token,Z=D===h,me=P===h&&D!==null&&D!==h,ve=((je=Ne(m||"",i))==null?void 0:je.weight)??1;return e.jsxs("div",{className:`token-chip token-chip-draggable ${Z?"is-dragging":""} ${me?"is-drop-target":""}`,title:`$${i.token}$`,onClick:()=>{D===null&&ae(i)},role:"button",tabIndex:0,draggable:!0,onDragStart:ie=>be(ie,h),onDragEnd:Ce,onDragEnter:()=>Ie(h),onDragOver:ie=>we(ie,h),onDrop:ie=>f(ie,h),onTouchStart:ie=>j(ie,h),onTouchMove:F,onTouchEnd:b,onKeyDown:ie=>{(ie.key==="Enter"||ie.key===" ")&&(ie.preventDefault(),ae(i))},children:[e.jsx("span",{className:"token-chip-drag-handle","aria-hidden":"true",children:e.jsx(it,{size:14})}),e.jsx("span",{className:"token-chip-label",children:Q}),Math.abs(ve-1)>1e-6?e.jsxs("span",{className:"token-chip-weight","aria-label":`Strength ${Re(ve)}x`,children:["×",Re(ve)]}):null,e.jsx("button",{type:"button",className:"token-chip-remove",onClick:ie=>{ie.stopPropagation(),he(i)},"aria-label":`Remove ${i.token}`,children:e.jsx(ct,{size:12})})]},`${i.token}-${i.index}`)})})]}):null,e.jsx(ft,{open:fe,onClose:()=>K(!1),title:"Alias strength",tokenLabel:G?`${G.displayName} • $${(H=G.tokenObj)==null?void 0:H.token}$`:"",weight:(G==null?void 0:G.weight)??1,onApply:i=>{G!=null&&G.tokenObj&&(o==null||o(Oe(m||"",G.tokenObj,i)))},onRemoveWeight:()=>{G!=null&&G.tokenObj&&(o==null||o(Oe(m||"",G.tokenObj,null)))},onDeleteToken:()=>{G!=null&&G.tokenObj&&he(G.tokenObj)}}),u.length?e.jsx("button",{type:"button",className:"stringinput-trailing ui-button is-ghost is-compact",onClick:()=>S?S(t):z(),title:S?"Open prompt composer":"Insert alias",children:S?e.jsx(Ut,{size:16}):e.jsx(qt,{size:16})}):null,e.jsx(ce,{})]})}const Nt=n.memo(bs),St=t=>t==null?void 0:String(t).trim().replace(/[^A-Za-z0-9_-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||void 0;function ys({name:t,label:s,description:a,value:r,onChange:o,disabled:l=!1,min:c,max:d,step:y,isFloat:g=!1,inputId:S}){const N=y??(g?.01:1),R=S??St(t),$=D=>{if(D===""||D===null||D===void 0)return"";const w=g?parseFloat(D):parseInt(D,10);return Number.isNaN(w)?"":w},O=D=>{const w=D.target.value,P=$(w);o==null||o(P)},V=D=>{if(D.key!=="ArrowUp"&&D.key!=="ArrowDown")return;D.preventDefault();const w=typeof r=="number"?r:$(String(r??""))||0,P=D.key==="ArrowUp"?N:-N;let W=w+P;if(typeof c=="number"&&(W=Math.max(c,W)),typeof d=="number"&&(W=Math.min(d,W)),g){const ee=typeof N=="number"?(String(N).split(".")[1]||"").length:2;W=parseFloat(W.toFixed(Math.max(ee,2)))}o==null||o(W)};return e.jsxs("div",{className:"w-full flex items-center gap-2",children:[e.jsx("input",{id:R,name:t,type:"number",inputMode:g?"decimal":"numeric",value:r??"",onChange:O,onKeyDown:V,disabled:l,min:c,max:d,step:N,"aria-label":s||t,"aria-describedby":a?`${R||St(t)||t}-description`:void 0,className:"ui-control ui-input"}),typeof c=="number"||typeof d=="number"?e.jsxs("div",{className:"hidden sm:flex flex-col text-[10px] text-[#6A6FA8] text-right leading-tight",children:[typeof c=="number"&&e.jsxs("span",{children:["min ",c]}),typeof d=="number"&&e.jsxs("span",{children:["max ",d]})]}):null]})}const qe=n.memo(ys);function ws({name:t,label:s,description:a,value:r,onChange:o,disabled:l=!1}){const c=!!r,d=()=>{l||o==null||o(!c)},y=g=>{(g.key===" "||g.key==="Enter")&&(g.preventDefault(),d())};return e.jsxs("button",{id:t,type:"button",role:"switch","aria-checked":c,"aria-label":s||t,"aria-describedby":a?`${t}-description`:void 0,onClick:d,onKeyDown:y,disabled:l,className:`ui-switch ${c?"is-on":""}`,children:[e.jsx("span",{className:"ui-switch-track",children:e.jsx("span",{className:"ui-switch-knob"})}),e.jsx("span",{className:"ui-switch-state",children:c?"On":"Off"})]})}const kt=n.memo(ws),vs=/\.(safetensors|ckpt|pt|pth)$/i;function Xe(t){if(typeof t!="string")return!1;const s=t.trim();if(!s)return!1;const r=s.replace(/\\/g,"/").split("/").filter(Boolean).pop()||"";return vs.test(r)}function zt(t){if(typeof t!="string")return{folder:"",base:""};const a=t.trim().replace(/\\/g,"/").split("/").filter(Boolean),o=(a.pop()||"").replace(/\.[^.]+$/,"");return{folder:a.join(" ").trim(),base:o}}function pt(t){if(!Xe(t))return t;const{folder:s,base:a}=zt(t);if(!a)return t;if(!s)return a;const r=s.split(/\s+/).filter(Boolean),o=r[r.length-1]||"";if(o&&a.toLowerCase().startsWith(o.toLowerCase())){const l=a.slice(o.length);return l?`${s}${l}`:s}return`${s} ${a}`.trim()}function js(t,s){try{if(typeof window>"u"||!t)return null;const a=t.getItem(s);return a?JSON.parse(a):null}catch{return null}}function nt(t,s,a){try{if(typeof window>"u"||!t)return;t.setItem(s,JSON.stringify(a))}catch{}}function $e(){try{return typeof window>"u"?null:window.sessionStorage||null}catch{return null}}function Be(){try{return typeof window>"u"?null:window.localStorage||null}catch{return null}}const Ft=750,Le=new Map,Ee=new Map,Ae=new Map,Ve=new Map,_e=new Map,Pe=new Map;function Ot(t){var s;if(Ee.has(t)&&(clearTimeout(Ee.get(t)),Ee.delete(t)),Ae.has(t)){try{(s=window.cancelIdleCallback)==null||s.call(window,Ae.get(t))}catch{}Ae.delete(t)}Le.has(t)&&(nt($e(),t,Le.get(t)),Le.delete(t))}function Ns(t){var r;if(Ee.has(t)&&(clearTimeout(Ee.get(t)),Ee.delete(t)),Ae.has(t)){try{(r=window.cancelIdleCallback)==null||r.call(window,Ae.get(t))}catch{}Ae.delete(t)}const s=()=>{Le.has(t)&&(nt($e(),t,Le.get(t)),Le.delete(t))},a=setTimeout(()=>{Ee.delete(t);try{if(typeof window<"u"&&typeof window.requestIdleCallback=="function"){const o=window.requestIdleCallback(()=>{Ae.delete(t),s()},{timeout:2500});Ae.set(t,o);return}}catch{}s()},Ft);Ee.set(t,a)}function Ss(){Array.from(Ee.values()).forEach(t=>clearTimeout(t)),Ee.clear(),Array.from(Ae.values()).forEach(t=>{var s;try{(s=window.cancelIdleCallback)==null||s.call(window,t)}catch{}}),Ae.clear(),Array.from(Le.entries()).forEach(([t,s])=>{nt($e(),t,s)}),Le.clear(),Array.from(_e.values()).forEach(t=>clearTimeout(t)),_e.clear(),Array.from(Pe.values()).forEach(t=>{var s;try{(s=window.cancelIdleCallback)==null||s.call(window,t)}catch{}}),Pe.clear(),Array.from(Ve.entries()).forEach(([t,s])=>{try{const a=$e();a&&a.setItem(t,s)}catch{}}),Ve.clear()}if(typeof window<"u"&&!window.__cozygenFormStateFlush){const t=()=>Ss();window.addEventListener("beforeunload",t),window.addEventListener("pagehide",t),window.__cozygenFormStateFlush=!0}function ks(t){var r;if(!t)return{};const s=`${t}_formData`,a=js($e(),s);if(a&&typeof a=="object")return a;try{const o=Be();(r=o==null?void 0:o.removeItem)==null||r.call(o,s)}catch{}return{}}function et(t,s,a={}){var l;if(!t)return;const{immediate:r=!1}=a||{},o=`${t}_formData`;if(r){Ot(o),nt($e(),o,s||{});try{const c=Be();(l=c==null?void 0:c.removeItem)==null||l.call(c,o)}catch{}return}Le.set(o,s||{}),Ns(o)}function Cs(t){t&&Ot(`${t}_formData`)}function $s(t,s,a=Ft){var l;if(Ve.set(t,s),_e.has(t)&&(clearTimeout(_e.get(t)),_e.delete(t)),Pe.has(t)){try{(l=window.cancelIdleCallback)==null||l.call(window,Pe.get(t))}catch{}Pe.delete(t)}const r=()=>{const c=Ve.get(t);Ve.delete(t);try{const d=$e();d&&d.setItem(t,c)}catch{}},o=setTimeout(()=>{_e.delete(t);try{if(typeof window<"u"&&typeof window.requestIdleCallback=="function"){const c=window.requestIdleCallback(()=>{Pe.delete(t),r()},{timeout:2e3});Pe.set(t,c);return}}catch{}r()},a);_e.set(t,o)}function Is(t,s={}){var o,l;const{immediate:a=!1}=s||{},r="cozygen_last_param";if(a){if(_e.has(r)&&(clearTimeout(_e.get(r)),_e.delete(r)),Pe.has(r)){try{(o=window.cancelIdleCallback)==null||o.call(window,Pe.get(r))}catch{}Pe.delete(r)}Ve.delete(r);try{const c=$e();c&&c.setItem(r,t||"");const d=Be();(l=d==null?void 0:d.removeItem)==null||l.call(d,r)}catch{}return}$s(r,t||"")}function Es(){var s,a;const t="cozygen_last_param";try{const r=$e(),o=((s=r==null?void 0:r.getItem)==null?void 0:s.call(r,t))||"";if(o)return o;const l=Be();(a=l==null?void 0:l.removeItem)==null||a.call(l,t)}catch{}return""}function Vt(t,s){const a=t?String(t):"global",r=s?String(s):"";return`cozygen_dropdown_folder:${a}:${r}`}function Ct(t,s){var r,o;const a=Vt(t,s);try{const l=$e(),c=((r=l==null?void 0:l.getItem)==null?void 0:r.call(l,a))||"";if(c)return c;const d=Be();(o=d==null?void 0:d.removeItem)==null||o.call(d,a)}catch{}return""}function As(t,s,a){var o;const r=Vt(t,s);try{const l=$e();l&&l.setItem(r,String(a||""));const c=Be();(o=c==null?void 0:c.removeItem)==null||o.call(c,r)}catch{}}function _s({workflowName:t,name:s,label:a,description:r,value:o,onChange:l,disabled:c=!1,options:d=[]}){const y=o??"",[g,S]=n.useState(()=>Ct(t,s)||"All");n.useEffect(()=>{const w=Ct(t,s);S(w||"All")},[t,s]);const N=n.useMemo(()=>(d||[]).map(w=>typeof w=="string"?{value:w,label:w}:{value:w.value??w.name??"",label:w.label??w.name??String(w.value??"")}),[d]),R=(w="")=>{if(typeof w!="string")return"Other";if(!w.includes("/"))return"root";const P=w.split("/");return P.slice(0,P.length-1).join("/")||"root"},$=n.useMemo(()=>{const w=new Set(["All"]);return N.forEach(P=>w.add(R(P.label))),Array.from(w).sort((P,W)=>P.localeCompare(W))},[N]);n.useEffect(()=>{$.includes(g)||S("All")},[$,g]),n.useEffect(()=>{As(t,s,g)},[t,s,g]);const O=n.useMemo(()=>{const w=P=>P.replace(/\.[^.]+$/,"");return N.filter(P=>{const W=R(P.label);return g==="All"||W===g}).map(P=>{const W=P.label||"";if(Xe(W)){const{base:M}=zt(W),J=pt(W);return{...P,label:g==="All"?J:M||J}}if(g==="All")return P;const ee=W.split("/"),oe=w(ee[ee.length-1]||W);return{...P,label:oe}}).sort((P,W)=>P.label.localeCompare(W.label))},[N,g]),V=n.useMemo(()=>y===""||y===null||y===void 0?!0:O.some(w=>String(w.value)===String(y)),[O,y]),D=w=>{l==null||l(w.target.value)};return e.jsxs("div",{className:"w-full space-y-2",children:[e.jsx("div",{className:"relative w-full",children:e.jsx("select",{value:g,onChange:w=>S(w.target.value),disabled:c,className:"ui-control ui-select is-compact","aria-label":`Choose folder for ${a||s}`,children:$.map(w=>e.jsx("option",{value:w,children:w},w))})}),e.jsx("div",{className:"relative w-full",children:e.jsxs("select",{id:s,name:s,value:y,onChange:D,disabled:c,"aria-label":a||s,"aria-describedby":r?`${s}-description`:void 0,className:"ui-control ui-select",children:[!V&&y!==""&&e.jsx("option",{value:y,children:pt(String(y))}),O.length>0&&(y===void 0||y==="")&&e.jsx("option",{value:"",children:"Select…"}),O.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value)),O.length===0&&e.jsx("option",{value:"",children:"No matches"})]},`${s||"field"}:${g}`)})]})}const ht=n.memo(_s);function $t(t=[]){return t.map(s=>typeof s=="string"?{value:s,label:s}:{value:s.value??s.name??"",label:s.label??s.name??String(s.value??"")})}function It(t,s){if(!t)return null;const a=String(t);if(s==="high"){const r=a.match(/(.+)-high(\.[^.]*)?$/i);return r?r[1]:null}if(s==="low"){const r=a.match(/(.+)-low(\.[^.]*)?$/i);return r?r[1]:null}return null}function Ps(t){return t?t.replace(/[_-]+/g," ").replace(/\s+/g," ").trim().replace(/^./,s=>s.toUpperCase()):""}const Rs=(...t)=>t.flat().map(a=>String(a??"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")).filter(Boolean).join("-")||"field";function Ls({name:t,label:s,description:a,highParam:r,lowParam:o,highChoices:l=[],lowChoices:c=[],formData:d={},onChangeParam:y,highStrengthParam:g,lowStrengthParam:S,strengthValue:N,onChangeStrength:R,highStrengthValue:$,lowStrengthValue:O,onChangeHighStrength:V,onChangeLowStrength:D,disabled:w=!1}){const P=n.useMemo(()=>$t(l),[l]),W=n.useMemo(()=>$t(c),[c]),ee=n.useMemo(()=>{const k=new Map;W.forEach(p=>{const z=It(p.value,"low");z&&(k.has(z)||k.set(z,p))});const v=[];return P.forEach(p=>{const z=It(p.value,"high");if(!z)return;const U=k.get(z);U&&v.push({base:z,label:Ps(z),highValue:p.value,lowValue:U.value})}),v.sort((p,z)=>p.label.localeCompare(z.label)),v},[P,W]),oe=n.useMemo(()=>{const k=d[r],v=d[o];if(!k||!v)return"";const p=ee.find(z=>z.highValue===k&&z.lowValue===v);return p?p.base:""},[d,r,o,ee]),M=g||S||`${t}_strength`,J=n.useMemo(()=>Rs(t||"lora",M||"strength"),[t,M]),B=!!(g||S),x=!!(g&&S),te=(k,v=1)=>typeof k=="number"?k:v,I=te(typeof N=="number"?N:typeof $=="number"?$:typeof O=="number"?O:void 0,1),ue=te(typeof $=="number"?$:void 0,I),re=te(typeof O=="number"?O:void 0,x?I:ue),xe=x&&Math.abs(ue-re)>1e-4,[ne,fe]=n.useState(xe);n.useEffect(()=>{fe(xe)},[xe,r,o]);const K=k=>{if(!y)return;const v=ee.find(p=>p.base===k);v&&(y(r,v.highValue),y(o,v.lowValue))};if(ee.length===0)return e.jsxs("div",{className:"text-[11px] text-[#9DA3FFCC]",children:["No matching ",e.jsx("span",{className:"font-semibold",children:"-high"})," /"," ",e.jsx("span",{className:"font-semibold",children:"-low"})," LoRA pairs found."]});const G=`${J}-linked`,C=`${J}-high`,m=`${J}-low`,u=x?"Linked":"Strength",E=x?"Applies to high + low":g||S||"",T=(k,v)=>{const p=Array.isArray(k)?k:[k];let z=!1;p.forEach(U=>{if(U==="high"&&typeof V=="function"){V(v);return}if(U==="low"&&typeof D=="function"){D(v);return}typeof R=="function"&&!z&&(R(v),z=!0)})},A=k=>{(g||!g&&!S)&&T("high",k),S&&T("low",k)},q=()=>{x&&fe(k=>{const v=!k;return v||A(typeof ue=="number"?ue:typeof re=="number"?re:I),v})};return e.jsxs("div",{className:"space-y-2",children:[e.jsx(ht,{name:`${t}_pair`,label:s,description:a,value:oe||"",onChange:K,disabled:w,options:ee.map(k=>({value:k.base,label:k.label}))}),B&&e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-[0.16em] text-[#9DA3FFCC]",children:"Strength"}),x&&e.jsx("button",{type:"button",className:"text-[10px] font-semibold tracking-[0.12em] uppercase text-[#E5E7FF]",onClick:q,disabled:w,children:ne?"Link values":"Split values"})]}),ne&&x?e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:gap-3",children:[e.jsxs("div",{className:"flex-1 max-w-[220px]",children:[e.jsxs("label",{htmlFor:C,className:"lora-strength-label is-high",children:[e.jsx("span",{className:"lora-strength-label-pill",children:"High"}),e.jsxs("span",{className:"lora-strength-label-text",children:["High strength",g&&e.jsx("span",{className:"lora-strength-label-hint",children:g})]})]}),e.jsx(qe,{name:`${M}_high`,label:"High strength",description:"",value:ue,onChange:k=>T("high",k),disabled:w,isFloat:!0,min:0,max:2,step:.05,inputId:C})]}),e.jsxs("div",{className:"flex-1 max-w-[220px]",children:[e.jsxs("label",{htmlFor:m,className:"lora-strength-label is-low",children:[e.jsx("span",{className:"lora-strength-label-pill",children:"Low"}),e.jsxs("span",{className:"lora-strength-label-text",children:["Low strength",S&&e.jsx("span",{className:"lora-strength-label-hint",children:S})]})]}),e.jsx(qe,{name:`${M}_low`,label:"Low strength",description:"",value:re,onChange:k=>T("low",k),disabled:w,isFloat:!0,min:0,max:2,step:.05,inputId:m})]})]}):e.jsxs("div",{className:"flex-1 max-w-[220px]",children:[e.jsxs("label",{htmlFor:G,className:"lora-strength-label is-linked",children:[e.jsx("span",{className:"lora-strength-label-pill",children:u}),e.jsxs("span",{className:"lora-strength-label-text",children:["LoRA strength",E&&e.jsx("span",{className:"lora-strength-label-hint",children:E})]})]}),e.jsx(qe,{name:M,label:"LoRA strength",description:"",value:I,onChange:A,disabled:w,isFloat:!0,min:0,max:2,step:.05,inputId:G})]})]})]})}function Ms(t,s){if(t.disabled!==s.disabled||t.name!==s.name||t.label!==s.label||t.description!==s.description||t.highParam!==s.highParam||t.lowParam!==s.lowParam||t.highStrengthParam!==s.highStrengthParam||t.lowStrengthParam!==s.lowStrengthParam||t.strengthValue!==s.strengthValue||t.highStrengthValue!==s.highStrengthValue||t.lowStrengthValue!==s.lowStrengthValue||t.highChoices!==s.highChoices||t.lowChoices!==s.lowChoices||t.onChangeParam!==s.onChangeParam||t.onChangeStrength!==s.onChangeStrength||t.onChangeHighStrength!==s.onChangeHighStrength||t.onChangeLowStrength!==s.onChangeLowStrength)return!1;const a=t.formData||{},r=s.formData||{};return!(a[t.highParam]!==r[s.highParam]||a[t.lowParam]!==r[s.lowParam])}const Et=n.memo(Ls,Ms);function Ds({id:t,label:s,description:a,preview:r,expanded:o=!1,onToggle:l,children:c,trailing:d,className:y=""}){const g=typeof l=="function",S=t?`${t}-description`:void 0,N=t?`${t}-panel`:void 0,R=typeof s=="string"?s.trim().replace(/\s+/gu," ").replace(/:\s*$/u,""):s,$=typeof a=="string"?a.trim().replace(/\s+/gu," "):a,O=typeof r=="string"||typeof r=="number"?String(r):void 0,V=g?"button":"div",D=g?{type:"button",onClick:l,"aria-expanded":o,"aria-controls":N,"aria-describedby":$?S:void 0}:{};return e.jsxs("div",{className:["field-row",y].filter(Boolean).join(" "),children:[e.jsxs(V,{...D,className:["field-row-head",g?"is-collapsible":"is-static",o?"is-expanded":""].filter(Boolean).join(" "),children:[e.jsxs("div",{className:"field-row-main",children:[e.jsx("div",{className:"field-row-label",children:R}),$?e.jsx("div",{id:S,className:"field-row-description",children:$}):null]}),e.jsxs("div",{className:"field-row-trailing",children:[d?e.jsx("div",{className:"field-row-trailing-control",children:d}):null,r?e.jsx("div",{className:"field-row-preview",title:O,children:r}):null,g?e.jsx("div",{className:"field-row-chevron","aria-hidden":"true",children:e.jsx(Rt,{size:16})}):null]})]}),g&&o?e.jsx("div",{id:N,className:"field-row-body",children:c}):null]})}const ot=n.memo(Ds),Ts=16,zs=[" - "," ","-","_"],Bt=t=>[...new Set(t.filter(Boolean))],tt=(t,s)=>{const a=String(t||"").trim(),r=zs.map(o=>`${a}${o}${s}`);return r.push(`${a}${s}`),Bt(r)},At=(t,s)=>{const a=tt(`${t} Strength`,s),r=tt(t,s).map(o=>`${o} Strength`);return Bt([...a,...r])},_t=t=>String(t||"").toLowerCase().replace(/[\s_-]+/g,""),Ye=(t,s=[])=>{if(!t)return null;const a=Array.isArray(s)?s:[s];for(const o of a){if(!o)continue;const l=t.get(o);if(l)return{name:o,input:l}}const r=new Map;a.forEach(o=>{o&&r.set(_t(o),o)});for(const[o,l]of t.entries()){const c=_t(o);if(r.has(c))return{name:o,input:l}}return null},Fs=Array.from({length:Ts},(t,s)=>{const a=s+1,r=tt("Lora High",a),o=tt("Lora Low",a),l=At("Lora High",a),c=At("Lora Low",a);return{id:`video_lora_${a}`,label:`Video LoRA ${a}`,highParam:r[0],lowParam:o[0],highParamAliases:r,lowParamAliases:o,highStrengthParam:l[0],lowStrengthParam:c[0],highStrengthParamAliases:l,lowStrengthParamAliases:c}});function Os(t){var r,o;const s=((r=t==null?void 0:t.inputs)==null?void 0:r.param_type)||((o=t==null?void 0:t.inputs)==null?void 0:o.Param_type),a=String(s||"STRING").toUpperCase();return["NUMBER","FLOAT","INT"].includes(a)?"NUMBER":["BOOLEAN","BOOL"].includes(a)?"BOOLEAN":["DROPDOWN","CHOICE","SELECT"].includes(a)?"DROPDOWN":"STRING"}function Vs(t){const s=(t==null?void 0:t.inputs)||{};return s.label||s.display_name||s.title||s.param_name||(t==null?void 0:t.title)||(t==null?void 0:t.class_type)||"Parameter"}function Bs(t){const s=(t==null?void 0:t.inputs)||{};return s.description||s.help||s.tooltip||s.doc||""}function Fe(t){const s=(t==null?void 0:t.inputs)||{};return s.param_name||s.name||s.key||s.id||`param_${(t==null?void 0:t.id)||"unknown"}`}function Ue(t){const s=(t==null?void 0:t.inputs)||{},a=s.choices||s.options||[],r=s.default_value??s.value??s.default_choice??(a&&a.length?a[0]:"")??"";return{paramName:Fe(t),label:Vs(t),description:Bs(t),paramType:Os(t),multiline:!!s.multiline,min:typeof s.min=="number"?s.min:void 0,max:typeof s.max=="number"?s.max:void 0,step:typeof s.step=="number"?s.step:void 0,choices:a,defaultValue:r}}function Ws({inputs:t=[],formData:s={},onFormChange:a,workflowName:r,onParamEdited:o,onSpotlight:l,compactControls:c=!0,collapseAllKey:d=0,collapseAllCollapsed:y=!0,lastEditedParam:g="",spotlightName:S="",onCloseSpotlight:N=()=>{},onVisibleParamsChange:R=()=>{},aliasOptions:$=[],aliasCatalog:O=[],onOpenComposer:V}){const[D,w]=n.useState({}),[P,W]=n.useState(0),ee=n.useRef(s);n.useEffect(()=>{ee.current=s},[s]);const oe=n.useCallback((C,m)=>{if((C==null?void 0:C.paramType)==="BOOLEAN")return m?"On":"Off";if(m==null||m==="")return"Empty";if(typeof m=="string"){const u=m.trim();if(!u)return"Empty";const E=240,T=140,A=u.length>E?u.slice(0,E):u,k=/[\r\n\t]/.test(A)||/\s{2,}/u.test(A)?A.replace(/\s+/gu," ").trim():A;if(k.length>T)return`${k.slice(0,T)}…`;const v=pt(k);return u.length>E?`${v}…`:v}return String(m)},[]),M=n.useCallback((C,m)=>{!a||!C||(a(C,m),o==null||o(C),w(u=>(u==null?void 0:u[C])===!1?u:{...u,[C]:!1}))},[a,o]),J=n.useCallback(C=>{C&&w(m=>({...m,[C]:!(m!=null&&m[C])}))},[]),B=n.useMemo(()=>t||[],[t]),x=n.useMemo(()=>{const C=new Map;return(B||[]).forEach(m=>{const u=Fe(m);u&&C.set(u,E=>M(u,E))}),C},[M,B]),te=n.useMemo(()=>{const C=new Map;return(B||[]).forEach(m=>{const u=Fe(m);u&&C.set(u,(E,T)=>{var A,q;M(u,E),(q=(A=T==null?void 0:T.target)==null?void 0:A.blur)==null||q.call(A),S===u&&(N==null||N())})}),C},[M,N,S,B]),I=n.useMemo(()=>{const C=new Map;return(B||[]).forEach(m=>{const u=Fe(m);u&&C.set(u,()=>J(u))}),C},[J,B]);n.useEffect(()=>{const C={};(t||[]).forEach(m=>{const u=Fe(m);u&&(C[u]=y)}),g&&(C[g]=!1),w(C)},[d,y,t,g]);const ue=n.useMemo(()=>{const C=new Map;return(t||[]).forEach(m=>{const u=Fe(m);u&&C.set(u,m)}),C},[t]),re=n.useMemo(()=>{const C=[];return Fs.forEach(m=>{const u=Ye(ue,m.highParamAliases||m.highParam),E=Ye(ue,m.lowParamAliases||m.lowParam);if(!u||!E)return;const T=u.input,A=E.input,q=Ue(T),k=Ue(A);if(q.paramType!=="DROPDOWN"||k.paramType!=="DROPDOWN")return;const v=q.choices||[],p=k.choices||[];if(!v.length||!p.length)return;const z=Ye(ue,m.highStrengthParamAliases||m.highStrengthParam),U=Ye(ue,m.lowStrengthParamAliases||m.lowStrengthParam);C.push({...m,highParam:u.name,lowParam:E.name,highStrengthParam:z==null?void 0:z.name,lowStrengthParam:U==null?void 0:U.name,highInput:T,lowInput:A,highCfg:q,lowCfg:k})}),C},[ue]),xe=n.useMemo(()=>{const C=new Map;return re.forEach(m=>{C.set(m.highParam,m)}),C},[re]),ne=n.useMemo(()=>{const C=new Set;return re.forEach(m=>{C.add(m.highParam),C.add(m.lowParam),m.highStrengthParam&&C.add(m.highStrengthParam),m.lowStrengthParam&&C.add(m.lowStrengthParam)}),C},[re]),fe=n.useMemo(()=>{const C=[];return(B||[]).forEach(m=>{const u=Ue(m),E=u.paramName,T=xe.get(E);if(T){C.push({name:E,label:T.label||u.label,description:u.description,render:A=>{const q=A||ee.current||{},k=T.highStrengthParam?q[T.highStrengthParam]:void 0,v=T.lowStrengthParam?q[T.lowStrengthParam]:void 0,p=k??v??1;return e.jsx(Et,{name:T.id||T.highParam,label:T.label||u.label,highParam:T.highParam,lowParam:T.lowParam,highChoices:T.highCfg.choices,lowChoices:T.lowCfg.choices,formData:q,onChangeParam:M,highStrengthParam:T.highStrengthParam,lowStrengthParam:T.lowStrengthParam,strengthValue:p,highStrengthValue:k,lowStrengthValue:v,onChangeHighStrength:T.highStrengthParam?x.get(T.highStrengthParam):void 0,onChangeLowStrength:T.lowStrengthParam?x.get(T.lowStrengthParam):void 0,disabled:!1},`lora-${E}-${P}`)}});return}ne.has(E)||C.push({name:E,label:u.label,description:u.description,render:A=>{const q=A||ee.current||{},k={name:E,label:u.label,description:u.description,value:q[E],defaultValue:u.defaultValue,disabled:!1};return u.paramType==="NUMBER"?e.jsx(qe,{...k,onChange:x.get(E),min:u.min,max:u.max,step:u.step,isFloat:!0},`field-${E}-number-${P}`):u.paramType==="BOOLEAN"?e.jsx(kt,{...k,onChange:x.get(E)},`field-${E}-bool-${P}`):u.paramType==="DROPDOWN"?e.jsx(ht,{...k,workflowName:r,onChange:x.get(E),options:u.choices||[]},`field-${E}-dropdown-${P}`):e.jsx(Nt,{...k,aliasOptions:$,aliasCatalog:O,onOpenComposer:V,onChange:x.get(E),onEnter:te.get(E),multiline:u.multiline},`field-${E}-string-${P}`)}})}),C},[B,xe,ne,P,r,$,O,V,M,x,te,S,N]),K=n.useMemo(()=>{const C=new Map;return fe.forEach(m=>C.set(m.name,m)),C},[fe]);n.useEffect(()=>{R==null||R(fe.map(C=>C.name))},[fe,R]);const G=n.useCallback(C=>{const m=fe.map(q=>q.name),u=K.get(C);if(!u)return;const E=m.indexOf(C),T=E>0?m[E-1]:null,A=E>=0&&E<m.length-1?m[E+1]:null;W(q=>q+1),l==null||l({name:C,label:u.label,description:u.description,render:q=>u.render(q||ee.current),order:m,index:E>=0?E:0,total:m.length,onPrev:T?()=>G(T):null,onNext:A?()=>G(A):null})},[K,l,fe]);return e.jsx("div",{className:"settings-list",children:B.map(C=>{const m=Ue(C),u=m.paramName,E=xe.get(u);if(E){const{id:U,label:pe,highParam:se,lowParam:ye,highStrengthParam:de,lowStrengthParam:he,highCfg:ae,lowCfg:ge}=E,be=de?s[de]:void 0,we=he?s[he]:void 0,Ie=be??we??1,Se=u?`param-${u}`:void 0,Ce=c?D[u]??!0:!!D[u],f=Ce?oe(m,[s[se],s[ye]].filter(Boolean).join(" • ")):null,j=(F=s)=>{const b=de?F==null?void 0:F[de]:void 0,_=he?F==null?void 0:F[he]:void 0,X=b??_??Ie;return e.jsx(Et,{name:U||se,label:pe||m.label,highParam:se,lowParam:ye,highChoices:ae.choices,lowChoices:ge.choices,formData:F,onChangeParam:M,highStrengthParam:de,lowStrengthParam:he,strengthValue:X,highStrengthValue:b,lowStrengthValue:_,onChangeHighStrength:de?x.get(de):void 0,onChangeLowStrength:he?x.get(he):void 0,disabled:!1},`lora-${u}`)};return e.jsx("div",{id:Se,"data-param-name":u,"data-param-label":pe||m.label,"data-param-type":"lora_pair",className:"settings-row",children:e.jsx(ot,{id:u,label:pe||m.label,description:m.description,preview:f,expanded:!Ce,onToggle:I.get(u),children:Ce?null:j(s)})},`lora_pair_${U||se}`)}if(ne.has(u))return null;const T=s[u],q={name:u,label:m.label,description:m.description,value:T,disabled:!1,defaultValue:m.defaultValue},k=(U=s,pe=!1)=>{const se={...q,value:U==null?void 0:U[u]};return m.paramType==="NUMBER"?e.jsx(qe,{...se,inputId:u,onChange:x.get(u),min:m.min,max:m.max,step:m.step,isFloat:!0},`field-${u}-number-${P}`):m.paramType==="BOOLEAN"?e.jsx(kt,{...se,onChange:x.get(u)},`field-${u}-bool-${P}`):m.paramType==="DROPDOWN"?e.jsx(ht,{...se,workflowName:r,onChange:x.get(u),options:m.choices||[]},`field-${u}-dropdown-${P}`):e.jsx(Nt,{...se,aliasOptions:$,aliasCatalog:O,onOpenComposer:V,onChange:x.get(u),onEnter:te.get(u),multiline:m.multiline||S===u||pe},`field-${u}-string-${P}`)},v=u?`param-${u}`:void 0,p=c?D[u]??!0:!!D[u];if(m.paramType==="BOOLEAN")return e.jsx("div",{id:v,"data-param-name":u,"data-param-label":m.label,"data-param-type":"single",className:"settings-row",children:e.jsx(ot,{id:u,label:m.label,description:m.description,trailing:k(s,!0)})},u);const z=p?oe(m,T):null;return e.jsx("div",{id:v,"data-param-name":u,"data-param-label":m.label,"data-param-type":"single",className:"settings-row",children:e.jsx(ot,{id:u,label:m.label,description:m.description,preview:z,expanded:!p,onToggle:I.get(u),children:p?null:k(s,!0)})},u)})})}function Gs(t){return(t||[]).map(s=>{var a;if(["CozyGenFloatInput","CozyGenIntInput","CozyGenStringInput","CozyGenChoiceInput"].includes(s.class_type)){let r=s.class_type.replace("CozyGen","").replace("Input","").toUpperCase();return r==="CHOICE"&&(r="DROPDOWN"),{...s,inputs:{...s.inputs,param_type:r,Multiline:((a=s.inputs)==null?void 0:a.display_multiline)||!1}}}return s})}function Us({workflowName:t,dynamicInputs:s,formData:a,onFormChange:r,sectionRef:o,compactControls:l=!1,collapseAllState:c=null,onSpotlight:d,spotlightName:y,onCloseSpotlight:g,onVisibleParamsChange:S,aliasOptions:N=[],aliasCatalog:R=[],onOpenComposer:$}){const O=n.useMemo(()=>Gs((s||[]).filter(V=>V.class_type!=="CozyGenImageInput")),[s]);return e.jsx("section",{className:"settings-surface scroll-mt-24",ref:o,children:e.jsx(Ws,{workflowName:t,inputs:O,formData:a,onFormChange:r,compactControls:l,collapseAllKey:(c==null?void 0:c.key)??0,collapseAllCollapsed:(c==null?void 0:c.collapsed)??!0,onSpotlight:d,spotlightName:y,onCloseSpotlight:g,onVisibleParamsChange:S,aliasOptions:N,aliasCatalog:R,onOpenComposer:$})})}function qs({workflowName:t,dynamicInputs:s,formData:a,onFormChange:r,parameterSectionRef:o,compactControls:l=!0,collapseAllState:c=null,onSpotlight:d,spotlightName:y,onCloseSpotlight:g,onVisibleParamsChange:S,aliasOptions:N=[],aliasCatalog:R=[],onOpenComposer:$}){return e.jsx(Us,{workflowName:t,dynamicInputs:s,formData:a,onFormChange:r,sectionRef:o,compactControls:l,collapseAllState:c,onSpotlight:d,spotlightName:y,onCloseSpotlight:g,onVisibleParamsChange:S,aliasOptions:N,aliasCatalog:R,onOpenComposer:$})}const lt=n.forwardRef(function({title:s,kicker:a,meta:r,defaultOpen:o=!0,variant:l="card",className:c="",bodyClassName:d,children:y},g){const S=l==="bare",N=(S?["collapsible-section","collapsible-section--bare",c]:["ui-panel","collapsible-card","sectioned-card",c]).filter(Boolean).join(" "),R=(S?["collapsible-section-body",d||"space-y-4"]:["collapsible-card-body",d||"space-y-4"]).filter(Boolean).join(" "),$=r!=null?e.jsx("div",{className:"collapsible-card-summary-meta",children:r}):null;return e.jsxs("details",{ref:g,className:N,open:o,children:[e.jsxs("summary",{className:S?"collapsible-section-summary":"collapsible-card-summary",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[a?e.jsx("span",{className:"ui-kicker",children:a}):null,e.jsx("span",{className:"text-sm font-semibold tracking-wide",children:s})]}),$,S?e.jsx("span",{className:"collapsible-section-chevron","aria-hidden":"true",children:e.jsx(Rt,{size:16})}):null]}),e.jsx("div",{className:R,children:y})]})});function Pt(t){try{return new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return""}}function Xs({open:t,onClose:s,logs:a=[],onClear:r}){const o=n.useMemo(()=>(a||[]).map(l=>`[${Pt(l.ts)}] ${String(l.level||"info").toUpperCase()} ${l.message}`).join(`
`),[a]);return e.jsx(Te,{open:t,onClose:s,title:"Run logs",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"ui-button is-muted w-full",onClick:()=>{var l,c;try{(c=(l=navigator.clipboard)==null?void 0:l.writeText)==null||c.call(l,o||"")}catch{}},children:"Copy"}),e.jsx("button",{type:"button",className:"ui-button is-ghost w-full",onClick:r,children:"Clear"}),e.jsx("button",{type:"button",className:"ui-button is-primary w-full",onClick:s,children:"Close"})]}),children:e.jsx("pre",{className:"runlog-pre",children:a!=null&&a.length?a.map((l,c)=>e.jsxs("div",{className:`runlog-line is-${l.level||"info"}`,children:[e.jsx("span",{className:"runlog-ts",children:Pt(l.ts)}),e.jsx("span",{className:"runlog-msg",children:l.message})]},`${l.ts}-${c}`)):"No logs yet."})})}function Hs(){const[t,s]=n.useState([]),[a,r]=n.useState(null),[o,l]=n.useState(!0),[c,d]=n.useState(null);n.useEffect(()=>{let g=!1;async function S(){l(!0),d(null);try{const N=await Xt();if(g)return;const R=(N==null?void 0:N.workflows)||[];s(R);let $=null;try{if($=typeof window<"u"?sessionStorage.getItem("selectedWorkflow"):null,typeof window<"u")try{localStorage.removeItem("selectedWorkflow")}catch{}}catch{$=null}if($&&R.includes($))r($);else if(R.length>0){r(R[0]);try{typeof window<"u"&&sessionStorage.setItem("selectedWorkflow",R[0])}catch{}}else r(null)}catch(N){if(g)return;console.error("Failed to load workflows",N),d(N)}finally{g||l(!1)}}return S(),()=>{g=!0}},[]);const y=n.useCallback(g=>{r(g);try{if(typeof window<"u"&&sessionStorage.setItem("selectedWorkflow",g),typeof window<"u")try{localStorage.removeItem("selectedWorkflow")}catch{}}catch{}},[]);return{workflows:t,selectedWorkflow:a,selectWorkflow:y,loading:o,error:c}}const Ks={clip_name1:"clip",clip_name2:"clip",unet_name:"unet",vae_name:"vae",sampler_name:"sampler",scheduler:"scheduler"},Ys=["CozyGenDynamicInput","CozyGenImageInput","CozyGenFloatInput","CozyGenIntInput","CozyGenStringInput","CozyGenChoiceInput"];function Js(t){const[s,a]=n.useState(null),[r,o]=n.useState([]),[l,c]=n.useState({}),[d,y]=n.useState(!1),[g,S]=n.useState(null);n.useEffect(()=>{if(!t){a(null),o([]),c({});return}let O=!1;const V=new AbortController;async function D(){y(!0),S(null);try{typeof performance<"u"&&performance.mark&&performance.mark("cozygen:workflow:load")}catch{}try{const w=await Ht(t,{signal:V.signal});if(O)return;for(const M in w){const J=w[M];J.class_type==="CozyGenImageInput"&&!J.inputs.param_name&&(J.inputs.param_name="Image Input"),w[M].id=M}a(w);const P=Object.values(w).filter(M=>Ys.includes(M.class_type)),W=await Promise.all(P.map(async M=>{const J=M.class_type==="CozyGenDynamicInput"&&M.inputs.param_type==="DROPDOWN",B=M.class_type==="CozyGenChoiceInput";if(J||B){const x=M.inputs.param_name;let te=M.inputs.choice_type||M.properties&&M.properties.choice_type;if(!te&&J&&(te=Ks[x]),te)try{const I=await Kt(te,{signal:V.signal});M.inputs.choices=I.choices||[]}catch(I){(I==null?void 0:I.name)!=="AbortError"&&console.error(`Choices for ${x} failed`,I),M.inputs.choices=[]}}return M}));if(O)return;o(W);const ee=ks(t),oe={};W.forEach(M=>{const J=M.inputs.param_name;if(!J)return;if(ee[J]!==void 0){oe[J]=ee[J];return}let B;if(["CozyGenDynamicInput","CozyGenFloatInput","CozyGenIntInput","CozyGenStringInput"].includes(M.class_type)){if(B=M.inputs.default_value,M.class_type==="CozyGenIntInput"){const x=parseInt(B,10);B=Number.isNaN(x)?0:x}else if(M.class_type==="CozyGenFloatInput"){const x=parseFloat(B);B=Number.isNaN(x)?0:x}}else if(M.class_type==="CozyGenChoiceInput"){const x=M.inputs.choices||[];B=x.length?x[0]:""}else M.class_type,B="";oe[J]=B}),c(oe);try{typeof performance<"u"&&performance.measure&&(performance.mark("cozygen:workflow:ready"),performance.measure(`cozygen:workflow:ready:${t||"unknown"}`,"cozygen:workflow:load","cozygen:workflow:ready"))}catch{}}catch(w){if(O)return;console.error("Failed to load workflow",w),S(w),a(null),o([])}finally{O||y(!1)}}return D(),()=>{Cs(t),O=!0,V.abort()}},[t]);const N=n.useMemo(()=>r.filter(O=>O.class_type==="CozyGenImageInput"),[r]),R=N[0]||null,$=n.useCallback((O,V)=>{c(D=>{const w={...D,[O]:V};return t&&et(t,w),w})},[t]);return{workflowData:s,dynamicInputs:r,imageInputs:N,primaryImageInput:R,formData:l,setFormData:c,handleFormChange:$,loading:d,error:g}}function Qs(t){return t?JSON.parse(JSON.stringify(t)):{}}function Zs(t,s,a){const r=Qs(t),o={...a||{}};if(!s||!Array.isArray(s))return{workflow:r,formData:o};for(const l of s){if(!l||!l.id||!l.inputs||!r[l.id])continue;const c=l.inputs.param_name;if(!c||l.class_type==="CozyGenImageInput")continue;let d=o[c];const y=r[l.id];if(!y||!y.inputs)continue;const g=l.class_type;d===void 0&&(g==="CozyGenChoiceInput"?d=l.inputs.value??l.inputs.default_choice??(l.inputs.choices&&l.inputs.choices[0])??"":d=l.inputs.default_value),d===void 0&&(d=""),o[c]=d,g==="CozyGenFloatInput"||g==="CozyGenIntInput"||g==="CozyGenStringInput"||g==="CozyGenDynamicInput"?y.inputs.default_value=d:g==="CozyGenChoiceInput"&&(y.inputs.value=d)}return{workflow:r,formData:o}}function en({selectedWorkflow:t,workflowData:s,dynamicInputs:a,imageInputs:r,formData:o,setFormData:l,promptAliases:c=null}){const[d,y]=n.useState(!1),[g,S]=n.useState(!1),[N,R]=n.useState(0),[$,O]=n.useState(0),[V,D]=n.useState("Idle"),[w,P]=n.useState("idle"),[W,ee]=n.useState([]),oe=n.useRef({ts:0,value:0,max:0}),M=n.useRef(null),J=n.useRef(s),B=n.useRef(o),x=n.useRef(!1),te=n.useRef(0),I=n.useRef(0),ue=n.useRef("idle"),re=n.useRef(null),xe=n.useRef(null);n.useEffect(()=>{J.current=s},[s]),n.useEffect(()=>{x.current=g},[g]),n.useEffect(()=>{te.current=N},[N]),n.useEffect(()=>{I.current=$},[$]),n.useEffect(()=>{ue.current=w},[w]),n.useEffect(()=>{B.current=o},[o]);const ne=()=>{re.current&&(clearTimeout(re.current),re.current=null)},fe=()=>{xe.current&&(clearTimeout(xe.current),xe.current=null)},K=n.useCallback((A,q,k=null)=>{const v={ts:Date.now(),level:A||"info",message:String(q||""),extra:k||null};ee(p=>{const z=[...p||[],v];return z.length>250?z.slice(z.length-250):z})},[]),G=n.useCallback(()=>ee([]),[]),C=()=>{if(!(typeof window>"u"||typeof window.dispatchEvent!="function"))try{window.dispatchEvent(new CustomEvent("cozygen:queue-finished"))}catch{}},m=()=>{fe(),xe.current=setTimeout(()=>{x.current||(P("idle"),D("Idle"),R(0),O(0))},8e3)},u=n.useCallback(()=>{ne(),y(!1),S(!1),R(0),O(0),D("Finished"),P("finished"),K("success","Finished"),m(),C()},[K]),E=n.useCallback((A="Error")=>{ne(),y(!1),S(!1),D(A),P("error"),K("error",A||"Error"),m()},[K]);n.useEffect(()=>{ne(),!(!g||!$||$<=0||N<$)&&(re.current=setTimeout(()=>{const A=x.current,q=te.current,k=I.current,v=ue.current;A&&k>0&&q>=k&&v!=="finished"&&v!=="error"&&u()},800))},[g,N,$,u]),n.useEffect(()=>{const A=()=>{const q=window.location.protocol==="https:"?"wss":"ws",k=window.location.host,v=Qt(),p=`${q}://${k}/ws${v?`?token=${encodeURIComponent(v)}`:""}`,z=new WebSocket(p);M.current=z,z.onmessage=U=>{var ye,de,he;if(typeof U.data!="string")return;let pe;try{pe=JSON.parse(U.data)}catch{return}const se=pe.type;if(se==="cozygen_batch_ready"){u();return}if(se==="execution_success"||se==="execution_finished"){x.current&&u();return}if(se==="execution_error"||se==="execution_interrupted"){K("error","Execution error"),E("Execution error");return}if(se==="status"){const ae=pe.data||{},ge=ae.status||ae,be=ge.exec_info||ae.exec_info||ge;if(be&&x.current){const we=be.queue_remaining??be.queue_pending??be.queue_remaining_items??0;(be.queue_running??be.running??0)===0&&we===0&&u()}return}if(se==="executing"){fe(),P("running");const ae=(ye=pe.data)==null?void 0:ye.node,ge=J.current;if(ae&&ge&&ge[ae]){const be=ge[ae],we=be.title||be.class_type||"Node";K("info",`Executing: ${we}`,{nodeId:ae}),D(`Executing: ${we}`)}else K("info","Executing…"),D("Executing…");return}if(se==="progress"){const ae=((de=pe.data)==null?void 0:de.value)??0,ge=((he=pe.data)==null?void 0:he.max)??0;R(ae),O(ge);const be=Date.now(),we=oe.current;be-we.ts>2500&&(ae!==we.value||ge!==we.max)&&ge>0&&(oe.current={ts:be,value:ae,max:ge},K("info",`Progress: ${ae}/${ge}`));return}},z.onclose=()=>{setTimeout(A,1e3)}};return A(),()=>{ne(),fe(),M.current&&(M.current.onclose=null,M.current.close())}},[K,E,u]);const T=n.useCallback(async(A={})=>{if(!s)return;const{overrides:q=null,persistFormState:k=!0}=A||{};ne(),fe(),y(!0),S(!0),D("Queuing prompt…"),P("queued"),R(0),O(0),K("info","Queuing prompt…",{workflow:t||""});const v=B.current||{},p=q?{...v,...q||{}}:v,z=ns(p,c||{}),{workflow:U,formData:pe}=Zs(s,a||[],z||{}),se={...pe,...p};k&&t&&et(t,se),k&&l(se);const ye=r||[];for(const de of ye){if(!de||!de.id||!de.inputs)continue;const he=de.inputs.param_name;if(!he)continue;const ae=se[he];if(!ae){alert(`Please upload or select an image for "${he}" before generating.`),E("Missing image input");return}U[de.id]&&U[de.id].inputs&&(U[de.id].inputs.image_filename=ae)}try{let de=U;if(c){const he=ae=>{if(typeof ae=="string")return rs(ae,c);if(Array.isArray(ae))return ae.map(ge=>he(ge));if(ae&&typeof ae=="object"){const ge=Array.isArray(ae)?[]:{};return Object.entries(ae).forEach(([be,we])=>{ge[be]=he(we)}),ge}return ae};try{de=he(U)}catch{de=U}}Yt({workflowName:t,workflow:de,timestamp:Date.now()}),await Jt({prompt:de}),K("info","Prompt queued")}catch(de){console.error("Failed to queue prompt",de),de!=null&&de.unauthorized?(K("error","Session expired. Please sign in again."),E("Session expired. Please sign in again."),window.location.hash="#/login"):(K("error","Error queuing prompt"),E("Error queuing prompt"))}},[s,a,r,c,t,l,E,K]);return{isLoading:d,progressValue:N,progressMax:$,statusText:V,statusPhase:w,handleGenerate:T,logEntries:W,clearLogs:G}}const tn="cozygen_field_order_v1";function sn(t,s){if(!t)return s;try{const a=JSON.parse(t);return a&&typeof a=="object"?a:s}catch{return s}}function nn(){if(typeof window>"u")return{};try{return sn(window.localStorage.getItem(tn),{})}catch{return{}}}function rn(t){if(Array.isArray(t))return{order:t.filter(Boolean),hidden:{}};if(!t||typeof t!="object")return{order:[],hidden:{}};const s=Array.isArray(t.order)?t.order.filter(Boolean):[],a=t.hidden&&typeof t.hidden=="object"?t.hidden:{};return{order:s,hidden:a}}function an(t){if(!t)return{order:[],hidden:{}};const a=nn()[t];return rn(a)}function on(t,s){let a=Array.isArray(s)?s:[];if(!t||a.length===0)return a;const{order:r,hidden:o}=an(t);if(r&&r.length){const l=new Map;a.forEach(d=>{var g;const y=(g=d==null?void 0:d.inputs)==null?void 0:g.param_name;y&&!l.has(y)&&l.set(y,d)});const c=[];r.forEach(d=>{const y=l.get(d);y&&(c.push(y),l.delete(d))}),a.forEach(d=>{var g;const y=(g=d==null?void 0:d.inputs)==null?void 0:g.param_name;if(!y){c.push(d);return}l.has(y)&&(c.push(d),l.delete(y))}),a=c}return a=a.filter(l=>{var d;const c=(d=l==null?void 0:l.inputs)==null?void 0:d.param_name;return c?!o[c]:!0}),a}const ln=n.memo(function({workflows:s,selectedWorkflow:a,onWorkflowChange:r,workflowData:o}){return e.jsx("div",{className:"context-bar",children:e.jsx("div",{className:"context-chip",children:e.jsxs("select",{value:a||"",onChange:l=>r(l.target.value),className:"context-select","aria-label":"Workflow",children:[e.jsx("option",{value:"",children:"Select workflow…"}),s.map(l=>e.jsx("option",{value:l,children:l},l))]})})})}),cn=n.memo(function({workflowData:s,expandedPrompt:a,onOpenComposer:r,promptFieldName:o}){return s?e.jsxs("div",{className:"studio-preview-card",children:[e.jsxs("div",{className:"studio-preview-head",children:[e.jsx("span",{className:"studio-preview-title",children:"Expanded prompt"}),e.jsx("button",{type:"button",onClick:()=>r(o),className:"ui-button is-muted is-compact",children:e.jsx("span",{children:"Open composer"})})]}),e.jsx("div",{className:"studio-preview-body",children:a||"—"})]}):null});function fn(){const{workflows:t=[],selectedWorkflow:s,selectWorkflow:a}=Hs(),{workflowData:r,dynamicInputs:o=[],imageInputs:l=[],formData:c,setFormData:d,handleFormChange:y}=Js(s),{aliases:g,aliasCategories:S,aliasLookup:N,aliasOptions:R}=as(),{isLoading:$,progressValue:O,progressMax:V,statusText:D,statusPhase:w,handleGenerate:P,logEntries:W,clearLogs:ee}=en({selectedWorkflow:s,workflowData:r,dynamicInputs:o,imageInputs:l,formData:c,setFormData:d,promptAliases:N}),oe=n.useRef(null),M=n.useRef(null),[J,B]=n.useState({key:0,collapsed:!0}),[x,te]=n.useState(()=>Es()),[I,ue]=n.useState(null),re=(I==null?void 0:I.name)||"",xe=n.useCallback(()=>ue(null),[]),[ne,fe]=n.useState(!1),[K,G]=n.useState("prompt"),[C,m]=n.useState(!1),[u,E]=n.useState([]),T=n.useRef(new Map),A=c||{},q=n.useMemo(()=>on(s,o),[s,o]),k=n.useMemo(()=>{const b=(q||o||[]).filter(H=>(H==null?void 0:H.class_type)!=="CozyGenImageInput"),_=/\b(checkpoint|ckpt|lora|model|vae|embedding|clip|sampler|scheduler|seed)\b/i,X=H=>{const i=String((H==null?void 0:H.paramName)||"").toLowerCase(),h=String((H==null?void 0:H.label)||"").toLowerCase(),L=`${i} ${h}`,Q=c==null?void 0:c[H==null?void 0:H.paramName],Z=typeof Q=="string"?Q:"";let me=0;return L.includes("prompt")&&(me+=100),L.includes("negative")&&L.includes("prompt")&&(me-=15),H!=null&&H.multiline&&(me+=10),Z.includes("$")&&(me+=20),_.test(L)&&(me-=200),Xe(Z)&&(me-=200),me};if(typeof(c==null?void 0:c.prompt)=="string")return"prompt";const Y=b.map(H=>Ue(H)).filter(H=>(H==null?void 0:H.paramType)==="STRING"&&(H==null?void 0:H.paramName));if(!Y.length){const H=Object.entries(c||{}).find(([,h])=>typeof h=="string"&&h.includes("$")&&!Xe(h));if(H)return H[0];const i=Object.entries(c||{}).find(([,h])=>typeof h=="string"&&!Xe(h));return(i==null?void 0:i[0])||"prompt"}let ce=Y[0],le=X(ce);for(let H=1;H<Y.length;H++){const i=Y[H],h=X(i);h>le&&(ce=i,le=h)}return(ce==null?void 0:ce.paramName)||"prompt"},[o,c,q]),v=n.useMemo(()=>{const b=[];return Object.entries(g||{}).forEach(([_,X])=>{const Y=String(_).split("::"),ce=Y.length>1,le=S&&S[_]||(ce?Y[0]:""),H=ce?Y.slice(1).join("::"):_,i={key:_,name:H,category:le,text:X,token:le?`${le}:${H}`:H};b.push({...i,...gt(i)})}),b},[g,S]);n.useEffect(()=>{if(w==="finished"&&typeof window<"u"){try{window.localStorage.setItem("cozygen_gallery_pending","1")}catch{}window.dispatchEvent(new Event("cozygen:gallery-pending"))}},[w]);const p=n.useMemo(()=>{if(k&&typeof(A==null?void 0:A[k])=="string")return k;if(typeof(A==null?void 0:A.prompt)=="string")return"prompt";const b=Object.entries(A||{}).find(([,X])=>typeof X=="string"&&X.includes("$"));if(b)return b[0];const _=Object.entries(A||{}).find(([,X])=>typeof X=="string");return(_==null?void 0:_[0])||""},[A,k]),z=n.useMemo(()=>{if(!p)return"";const b=(A==null?void 0:A[p])||"";return typeof b=="string"?b:String(b??"")},[p,A]),U=n.useDeferredValue(z),pe=n.useMemo(()=>{const _=Y=>Y&&Y.length>2600?`${Y.slice(0,2600)}…`:Y,X=U||"";if(!X)return"";if(!N||!X.includes("$"))return _(X);try{const Y=X.replace(/\$([a-z0-9_:-]+)\$/gi,(ce,le)=>{const H=N.get(le.toLowerCase());return typeof H=="string"?H:ce});return _(Y)}catch{return _(X)}},[N,U]),se=n.useCallback(b=>{!b||b===s||(s&&et(s,c||{},{immediate:!0}),a(b))},[c,s,a]);n.useCallback(b=>{b&&d(_=>{const X={..._||{},...b||{}};return s&&et(s,X),X})},[s,d]);const ye=n.useCallback((b="prompt")=>{G(b),fe(!0)},[]),de=n.useCallback(b=>{K&&y(K,b)},[K,y]),he=n.useCallback(()=>{ye(k||"prompt")},[ye,k]),ae=l||[],ge=!!(r&&s),be=ae.length>0,we=r?be?`${ae.length} slots`:"No inputs":"Waiting",Ie=r?"":"Waiting",Se=n.useCallback((b,_)=>{const X=T.current;_&&b&&X.set(b,_);const Y=u.length?u:(_==null?void 0:_.order)||[],ce=Y.length,le=ce>0?Y.indexOf(b):-1,H=le>0?Y[le-1]:null,i=le>=0&&le<ce-1?Y[le+1]:null,h=H?X.get(H):null,L=i?X.get(i):null;return{..._,index:le>=0?le:0,total:ce,onPrev:h?()=>ue(Se(H,h)):null,onNext:L?()=>ue(Se(i,L)):null,onRender:P}},[u,P]),Ce=n.useCallback(b=>{const _=b||[];E(X=>X.length===_.length&&X.every((Y,ce)=>Y===_[ce])?X:_)},[]),f=n.useCallback(b=>{const _=b||"";te(_),Is(_)},[]),j=n.useCallback(b=>{b!=null&&b.name&&ue(Se(b.name,b))},[Se]),F=n.useCallback(()=>{var b;return(b=I==null?void 0:I.render)==null?void 0:b.call(I,c)},[I,c]);return n.useEffect(()=>{const b=()=>{!ge||$||P()};return window.addEventListener("cozygen:request-render",b),()=>window.removeEventListener("cozygen:request-render",b)},[P,ge,$]),n.useEffect(()=>{const b=_=>{var Y;const X=(Y=_==null?void 0:_.detail)==null?void 0:Y.fieldName;if(typeof X=="string"&&X.trim()){ye(X.trim());return}he()};return window.addEventListener("cozygen:open-composer",b),()=>window.removeEventListener("cozygen:open-composer",b)},[ye,he]),n.useEffect(()=>{const b=w==="queued"||w==="running"||$;try{window.dispatchEvent(new CustomEvent("cozygen:render-state",{detail:{active:b}}))}catch{}},[w,$]),!t||t.length===0?e.jsx("div",{className:"page-shell",children:e.jsx("div",{className:"neon-card px-3 py-3 sm:px-4 sm:py-4",children:e.jsx("p",{className:"text-sm text-[#9DA3FFCC]",children:"No workflows found. Drop a workflow file in CozyGen and refresh."})})}):e.jsxs("div",{className:"page-shell page-stack has-dock",children:[e.jsxs(lt,{kicker:"Parameters",title:e.jsxs(e.Fragment,{children:[e.jsx(es,{size:18,className:"inline-block mr-2 align-text-bottom"}),"Controls"]}),meta:Ie,bodyClassName:"control-shell",defaultOpen:!0,variant:"bare",children:[e.jsx(ln,{workflows:t,selectedWorkflow:s,onWorkflowChange:se,workflowData:r}),r?e.jsxs("div",{className:"controls-toolbar",children:[e.jsxs("div",{className:"controls-toolbar-row",children:[e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>B(b=>({key:b.key+1,collapsed:!0})),children:"Collapse all"}),e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>B(b=>({key:b.key+1,collapsed:!1})),children:"Expand all"})]}),e.jsxs("div",{className:"controls-toolbar-row",children:[e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:()=>ye(k),children:"Open composer"}),e.jsx("button",{type:"button",className:"ui-button is-ghost is-compact",onClick:()=>{var b,_;return(_=(b=oe.current)==null?void 0:b.scrollIntoView)==null?void 0:_.call(b,{block:"start",behavior:"smooth"})},children:"Jump to top"})]})]}):null,r?e.jsx(qs,{workflowName:s,dynamicInputs:q,formData:c,onFormChange:y,parameterSectionRef:oe,compactControls:!0,collapseAllState:J,lastEditedParam:x,spotlightName:re,onCloseSpotlight:xe,onVisibleParamsChange:Ce,aliasOptions:R,aliasCatalog:v,onOpenComposer:ye,onParamEdited:f,onSpotlight:j}):e.jsxs("div",{className:"empty-state-inline",children:[e.jsx("span",{className:"empty-state-arrow",children:e.jsx(Zt,{size:20})}),e.jsx("span",{children:"Select a workflow above to get started"})]}),e.jsx(cn,{workflowData:r,expandedPrompt:pe,onOpenComposer:ye,promptFieldName:k})]}),e.jsx(lt,{kicker:"Run",title:e.jsxs(e.Fragment,{children:[e.jsx(ts,{size:18,className:"inline-block mr-2 align-text-bottom"}),"Status"]}),meta:D||"Idle",defaultOpen:!1,className:"studio-status-card is-compact",children:e.jsxs("div",{className:"run-status-strip",children:[e.jsxs("div",{className:"run-status-left",children:[e.jsx("div",{className:`run-status-dot is-${w||"idle"}`,"aria-hidden":"true"}),e.jsxs("div",{className:"run-status-text",children:[e.jsx("div",{className:"run-status-phase",children:w||"idle"}),e.jsx("div",{className:"run-status-msg",children:D||"Idle"})]})]}),e.jsxs("div",{className:"run-status-actions",children:[$&&V>0?e.jsx("div",{className:"run-status-meter","aria-label":"Progress",children:e.jsx("div",{className:"run-status-meter-fill",style:{width:`${Math.max(0,Math.min(100,Math.round((O||0)/V*100)))}%`}})}):null,e.jsx("button",{type:"button",className:"ui-button is-muted is-compact",onClick:()=>m(!0),children:"View logs"})]})]})}),be?e.jsx(lt,{ref:M,className:"scroll-mt-24 is-compact",kicker:"Assets",title:e.jsxs(e.Fragment,{children:[e.jsx(ss,{size:18,className:"inline-block mr-2 align-text-bottom"}),"Images"]}),meta:we,defaultOpen:!1,variant:"bare",children:r?e.jsx("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:ae.map(b=>e.jsx(ps,{input:b,value:c[b.inputs.param_name]||"",onFormChange:y},b.id))}):null}):null,e.jsx("section",{className:"dock-panel",children:e.jsx(ls,{busy:$,progressValue:O,progressMax:V,statusText:D,statusPhase:w,primaryLabel:"Render",onPrimary:P,primaryDisabled:!ge})}),e.jsx(hs,{open:!!I,onClose:xe,title:I==null?void 0:I.label,description:I==null?void 0:I.description,render:F,index:(I==null?void 0:I.index)??0,total:(I==null?void 0:I.total)??0,onPrev:(I==null?void 0:I.onPrev)||null,onNext:(I==null?void 0:I.onNext)||null,onRender:(I==null?void 0:I.onRender)||null,children:null}),e.jsx(gs,{open:ne,onClose:()=>fe(!1),value:(c==null?void 0:c[K])||"",onChange:de,aliasOptions:R,aliasCatalog:v,aliasLookup:N,fieldLabel:K}),e.jsx(Xs,{open:C,onClose:()=>m(!1),logs:W,onClear:ee})]})}export{fn as default};
